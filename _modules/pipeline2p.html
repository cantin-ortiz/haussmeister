<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pipeline2p &mdash; haussmeister 0.2.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.3.6/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.3.6/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="haussmeister 0.2.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          haussmeister</a>
        <span class="navbar-text navbar-version pull-left"><b>0.2</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../usage/index.html">haussmeister</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <h1>Source code for pipeline2p</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module for feeding ThorLabs imaging datasets into a 2p imaging analysis</span>
<span class="sd">pipeline</span>

<span class="sd">(c) 2015 C. Schmidt-Hieber</span>
<span class="sd">GPLv3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="kn">as</span> <span class="nn">mp</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span> <span class="kn">as</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="kn">as</span> <span class="nn">stats</span>
<span class="kn">from</span> <span class="nn">scipy.io</span> <span class="kn">import</span> <span class="n">savemat</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.gridspec</span> <span class="kn">as</span> <span class="nn">gridspec</span>

<span class="kn">import</span> <span class="nn">cv2</span>

<span class="kn">import</span> <span class="nn">sima</span>
<span class="kn">import</span> <span class="nn">sima.motion</span>
<span class="kn">import</span> <span class="nn">sima.segment</span>
<span class="kn">import</span> <span class="nn">sima.spikes</span>
<span class="kn">from</span> <span class="nn">sima.ROI</span> <span class="kn">import</span> <span class="n">ROIList</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">utils</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">haussio</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">movies</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">scalebars</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">spectral</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">cnmf</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">motion</span>
<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">utils</span>
    <span class="kn">import</span> <span class="nn">haussio</span>
    <span class="kn">import</span> <span class="nn">movies</span>
    <span class="kn">import</span> <span class="nn">scalebars</span>
    <span class="kn">import</span> <span class="nn">spectral</span>
    <span class="kn">import</span> <span class="nn">cnmf</span>
    <span class="kn">import</span> <span class="nn">motion</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">stfio</span>
    <span class="kn">from</span> <span class="nn">stfio</span> <span class="kn">import</span> <span class="n">plot</span> <span class="k">as</span> <span class="n">stfio_plot</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;stfio module missing</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">haussmeister</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;nt&quot;</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/py2p/tools&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;HOME&quot;</span><span class="p">]))</span>

<span class="n">bar1_color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span>   <span class="c1"># black</span>
<span class="n">bar2_color</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span>   <span class="c1"># white</span>
<span class="n">edge_color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span>   <span class="c1"># black</span>
<span class="n">gap2</span> <span class="o">=</span> <span class="mf">0.15</span>         <span class="c1"># gap between series</span>
<span class="n">bar_width</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="n">NCPUS</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Maximal number of frames that thunder ICA can deal with before running</span>
<span class="c1"># out of memory (128 GB)</span>
<span class="n">MAXFRAMES_ICA</span> <span class="o">=</span> <span class="mi">1600</span>


<div class="viewcode-block" id="ThorExperiment"><a class="viewcode-back" href="../usage/pipeline2p.html#pipeline2p.ThorExperiment">[docs]</a><span class="k">class</span> <span class="nc">ThorExperiment</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper class to feed ThorLabs imaging datasets into a 2p imaging</span>
<span class="sd">    analysis pipeline</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    fn2p : str</span>
<span class="sd">        File path (relative to root_path) leading to directory that contains</span>
<span class="sd">        tiff series</span>
<span class="sd">    ch2p : str</span>
<span class="sd">        Channel. Default: &quot;A&quot;</span>
<span class="sd">    area2p : str</span>
<span class="sd">        Brain area code (e.g. &quot;CA1&quot;). Default: None</span>
<span class="sd">    fnsync : str</span>
<span class="sd">        Thorsync directory name. Default: None</span>
<span class="sd">    fnvr : str</span>
<span class="sd">        VR file name trunk. Default: None</span>
<span class="sd">    roi_subset : str</span>
<span class="sd">        String appended to roi label to distinguish between roi subsets.</span>
<span class="sd">        Default: &quot;&quot;</span>
<span class="sd">    mc_method : str</span>
<span class="sd">        Motion correction method. One of &quot;hmmc&quot;, &quot;dft&quot;, &quot;hmmcres&quot;, &quot;hmmcframe&quot;,</span>
<span class="sd">        &quot;hmmcpx&quot;, &quot;calblitz&quot;. Default: &quot;hmmc&quot;</span>
<span class="sd">    detrend : bool</span>
<span class="sd">        Whether to detrend fluorescence traces. Default: False</span>
<span class="sd">    roi_translate : 2-tuple of ints</span>
<span class="sd">        Apply ROI translation in x and y. Default: None</span>
<span class="sd">    root_path : str</span>
<span class="sd">        Root directory leading to fn2p. Default: &quot;&quot;</span>
<span class="sd">    seg_method : str, optional</span>
<span class="sd">        One of &quot;thunder&quot; (ROIs are identified by thunder&#39;s ICA), &quot;sima&quot; (ROIs</span>
<span class="sd">        are identified by SIMA&#39;s stICA), &quot;ij&quot; (an ImageJ RoiSet is used), </span>
<span class="sd">        &quot;cnmf&quot; (constrained non-negative matrix factorization).</span>
<span class="sd">        Default: &quot;cnmf&quot;</span>
<span class="sd">    maxtime : float, optional</span>
<span class="sd">        Limit data to maxtime. Default: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn2p</span><span class="p">,</span> <span class="n">ch2p</span><span class="o">=</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="n">area2p</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fnsync</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fnvr</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">roi_subset</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">mc_method</span><span class="o">=</span><span class="s2">&quot;hmmc&quot;</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">nrois_init</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                 <span class="n">roi_translate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">root_path</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s2">&quot;thor&quot;</span><span class="p">,</span>
                 <span class="n">dx</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">seg_method</span><span class="o">=</span><span class="s2">&quot;cnmf&quot;</span><span class="p">,</span> <span class="n">maxtime</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fn2p</span> <span class="o">=</span> <span class="n">fn2p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ch2p</span> <span class="o">=</span> <span class="n">ch2p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">area2p</span> <span class="o">=</span> <span class="n">area2p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fnsync</span> <span class="o">=</span> <span class="n">fnsync</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fnvr</span> <span class="o">=</span> <span class="n">fnvr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roi_subset</span> <span class="o">=</span> <span class="n">roi_subset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roi_translate</span> <span class="o">=</span> <span class="n">roi_translate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_path</span> <span class="o">=</span> <span class="n">root_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_path</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn2p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_path_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ftype</span> <span class="o">=</span> <span class="n">ftype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="n">dx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nrois_init</span> <span class="o">=</span> <span class="n">nrois_init</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxtime</span> <span class="o">=</span> <span class="n">maxtime</span>

        <span class="k">assert</span><span class="p">(</span><span class="n">seg_method</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;thunder&quot;</span><span class="p">,</span> <span class="s2">&quot;sima&quot;</span><span class="p">,</span> <span class="s2">&quot;ij&quot;</span><span class="p">,</span> <span class="s2">&quot;cnmf&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seg_method</span> <span class="o">=</span> <span class="n">seg_method</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnsync</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sync_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">fnsync</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sync_path</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnvr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vr_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">fnvr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vr_path_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vr_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vr_path</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vr_path_comp</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mc_method</span> <span class="o">=</span> <span class="n">mc_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mc_suffix</span> <span class="o">=</span> <span class="s2">&quot;_mc_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc_method</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc_method</span> <span class="o">==</span> <span class="s2">&quot;hmmc&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mc_suffix</span> <span class="o">=</span> <span class="s2">&quot;_mc&quot;</span>  <span class="c1"># special case</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mc_approach</span> <span class="o">=</span> <span class="n">sima</span><span class="o">.</span><span class="n">motion</span><span class="o">.</span><span class="n">HiddenMarkov2D</span><span class="p">(</span>
                <span class="n">granularity</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="n">max_displacement</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span>
                <span class="n">n_processes</span><span class="o">=</span><span class="n">NCPUS</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc_method</span> <span class="o">==</span> <span class="s2">&quot;dft&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mc_approach</span> <span class="o">=</span> <span class="n">sima</span><span class="o">.</span><span class="n">motion</span><span class="o">.</span><span class="n">DiscreteFourier2D</span><span class="p">(</span>
                <span class="n">max_displacement</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span> <span class="n">n_processes</span><span class="o">=</span><span class="n">NCPUS</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc_method</span> <span class="o">==</span> <span class="s2">&quot;hmmcres&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mc_approach</span> <span class="o">=</span> <span class="n">sima</span><span class="o">.</span><span class="n">motion</span><span class="o">.</span><span class="n">ResonantCorrection</span><span class="p">(</span>
                <span class="n">sima</span><span class="o">.</span><span class="n">motion</span><span class="o">.</span><span class="n">HiddenMarkov2D</span><span class="p">(</span>
                    <span class="n">granularity</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="n">max_displacement</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span>
                    <span class="n">n_processes</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc_method</span> <span class="o">==</span> <span class="s2">&quot;hmmcframe&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mc_approach</span> <span class="o">=</span> <span class="n">sima</span><span class="o">.</span><span class="n">motion</span><span class="o">.</span><span class="n">HiddenMarkov2D</span><span class="p">(</span>
                <span class="n">granularity</span><span class="o">=</span><span class="s1">&#39;frame&#39;</span><span class="p">,</span> <span class="n">max_displacement</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span>
                <span class="n">n_processes</span><span class="o">=</span><span class="n">NCPUS</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc_method</span> <span class="o">==</span> <span class="s2">&quot;hmmcpx&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mc_approach</span> <span class="o">=</span> <span class="n">sima</span><span class="o">.</span><span class="n">motion</span><span class="o">.</span><span class="n">HiddenMarkov2D</span><span class="p">(</span>
                <span class="n">granularity</span><span class="o">=</span><span class="s1">&#39;column&#39;</span><span class="p">,</span> <span class="n">max_displacement</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span>
                <span class="n">n_processes</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc_method</span> <span class="o">==</span> <span class="s2">&quot;calblitz&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mc_approach</span> <span class="o">=</span> <span class="n">motion</span><span class="o">.</span><span class="n">CalBlitz</span><span class="p">(</span>
                <span class="n">max_displacement</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span> <span class="n">fr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">to_haussio</span><span class="p">()</span><span class="o">.</span><span class="n">fps</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc_method</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mc_suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mc_approach</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sima_mc_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_path_comp</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc_suffix</span> <span class="o">+</span> <span class="s2">&quot;.sima&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mc_tiff_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_path_comp</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc_suffix</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">movie_mc_fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_path_comp</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc_suffix</span> <span class="o">+</span> <span class="s2">&quot;.mp4&quot;</span>

        <span class="c1"># Do not add translation string to original roi file name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roi_path_mc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_path_comp</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc_suffix</span> <span class="o">+</span> <span class="s1">&#39;/RoiSet&#39;</span> <span class="o">+</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">roi_subset</span> <span class="o">+</span> <span class="s1">&#39;.zip&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi_translate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">roi_subset</span> <span class="o">+=</span> <span class="s2">&quot;_{0}_{1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">roi_translate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi_translate</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">spikefn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_path_comp</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc_suffix</span> <span class="o">+</span> <span class="s2">&quot;_infer&quot;</span> <span class="o">+</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">roi_subset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detrend</span> <span class="o">=</span> <span class="n">detrend</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">detrend</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spikefn</span> <span class="o">+=</span> <span class="s2">&quot;_detrend.pkl&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spikefn</span> <span class="o">+=</span> <span class="s2">&quot;.pkl&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">proj_fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_path_comp</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc_suffix</span> <span class="o">+</span> <span class="s2">&quot;_proj.npy&quot;</span>

<div class="viewcode-block" id="ThorExperiment.to_haussio"><a class="viewcode-back" href="../usage/pipeline2p.html#pipeline2p.ThorExperiment.to_haussio">[docs]</a>    <span class="k">def</span> <span class="nf">to_haussio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mc</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert experiment to haussio.HaussIO</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mc : bool, optional</span>
<span class="sd">            Use motion corrected images. Default: False</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dataset : haussio.HaussIO</span>
<span class="sd">            A haussio.HaussIO instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftype</span> <span class="o">==</span> <span class="s2">&quot;thor&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mc</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">haussio</span><span class="o">.</span><span class="n">ThorHaussIO</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="n">chan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ch2p</span><span class="p">,</span>
                    <span class="n">sync_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sync_path</span><span class="p">,</span> <span class="n">width_idx</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                    <span class="n">maxtime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maxtime</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">haussio</span><span class="o">.</span><span class="n">ThorHaussIO</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc_suffix</span><span class="p">,</span>
                    <span class="n">chan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ch2p</span><span class="p">,</span> <span class="n">xml_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="o">+</span><span class="s2">&quot;/Experiment.xml&quot;</span><span class="p">,</span>
                    <span class="n">sync_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sync_path</span><span class="p">,</span> <span class="n">width_idx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                    <span class="n">maxtime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maxtime</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftype</span> <span class="o">==</span> <span class="s2">&quot;movie&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mc</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">haussio</span><span class="o">.</span><span class="n">MovieHaussIO</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">chan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ch2p</span><span class="p">,</span>
                    <span class="n">sync_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sync_path</span><span class="p">,</span> <span class="n">width_idx</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">haussio</span><span class="o">.</span><span class="n">MovieHaussIO</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc_suffix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
                    <span class="n">chan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ch2p</span><span class="p">,</span> <span class="n">sync_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sync_path</span><span class="p">,</span> <span class="n">width_idx</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></div>

<div class="viewcode-block" id="ThorExperiment.to_sima"><a class="viewcode-back" href="../usage/pipeline2p.html#pipeline2p.ThorExperiment.to_sima">[docs]</a>    <span class="k">def</span> <span class="nf">to_sima</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mc</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">haussio_data</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert experiment to sima.ImagingDataset</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mc : bool, optional</span>
<span class="sd">            Use motion corrected images. Default: False</span>
<span class="sd">        haussio_data : haussio.HaussIO, optional</span>
<span class="sd">            A pre-existing HaussIO object to save memory. Default: None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dataset : sima.ImagingDataset</span>
<span class="sd">            A sima.ImagingDataset instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mc</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc_suffix</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">sima_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_path_comp</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s2">&quot;.sima&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sima_dir</span><span class="p">):</span>
            <span class="n">restore</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">sima</span><span class="o">.</span><span class="n">ImagingDataset</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">sima_dir</span><span class="p">)</span>
            <span class="n">restore</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">EOFError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
            <span class="n">restore</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">restore</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dataset</span><span class="o">.</span><span class="n">channel_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch2p</span><span class="p">)</span>
                <span class="n">dataset</span><span class="o">.</span><span class="n">sequences</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">):</span>
                <span class="n">restore</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">restore</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">haussio_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">haussio_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_haussio</span><span class="p">(</span><span class="n">mc</span><span class="o">=</span><span class="n">mc</span><span class="p">)</span>
            <span class="n">sima_bak</span> <span class="o">=</span> <span class="n">haussio_data</span><span class="o">.</span><span class="n">sima_dir</span> <span class="o">+</span> <span class="s2">&quot;.bak&quot;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">haussio_data</span><span class="o">.</span><span class="n">sima_dir</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sima_bak</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">sima_bak</span><span class="p">)</span>
                <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sima_bak</span><span class="p">):</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">haussio_data</span><span class="o">.</span><span class="n">sima_dir</span><span class="p">,</span> <span class="n">sima_bak</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">haussio_data</span><span class="o">.</span><span class="n">sima_dir</span><span class="p">)</span>
                <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">haussio_data</span><span class="o">.</span><span class="n">sima_dir</span><span class="p">):</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">haussio_data</span><span class="o">.</span><span class="n">tosima</span><span class="p">(</span><span class="n">stopIdx</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dataset</span></div></div>


<div class="viewcode-block" id="thor_preprocess"><a class="viewcode-back" href="../usage/pipeline2p.html#pipeline2p.thor_preprocess">[docs]</a><span class="k">def</span> <span class="nf">thor_preprocess</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ffmpeg</span><span class="o">=</span><span class="n">movies</span><span class="o">.</span><span class="n">FFMPEG</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read in ThorImage dataset, apply motion correction, export motion-corrected</span>
<span class="sd">    tiffs, produce movie of corrected and uncorrected data</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : ThorExperiment</span>
<span class="sd">        The ThorExperiment to be processed</span>
<span class="sd">    ffmpeg : str, optional</span>
<span class="sd">        Path to ffmpeg binary. Default: movies.FFMPEG global variable</span>
<span class="sd">    compress : boolean, optional</span>
<span class="sd">        Compress resulting raw file with xz. Default: False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">haussio_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to_haussio</span><span class="p">(</span><span class="n">mc</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">haussio_data</span><span class="o">.</span><span class="n">movie_fn</span><span class="p">):</span>
        <span class="n">raw_movie</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">html_movie</span><span class="p">(</span><span class="n">haussio_data</span><span class="o">.</span><span class="n">movie_fn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">raw_movie</span> <span class="o">=</span> <span class="n">haussio_data</span><span class="o">.</span><span class="n">make_movie</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="mf">14.0</span><span class="p">,</span> <span class="n">crf</span><span class="o">=</span><span class="mi">28</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">raw_movie</span> <span class="o">=</span> <span class="n">haussio_data</span><span class="o">.</span><span class="n">make_movie</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">crf</span><span class="o">=</span><span class="mi">28</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">haussio_data</span><span class="o">.</span><span class="n">sima_dir</span><span class="p">):</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">haussio_data</span><span class="o">.</span><span class="n">tosima</span><span class="p">(</span><span class="n">stopIdx</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to_sima</span><span class="p">(</span><span class="n">mc</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">haussio_data</span><span class="o">=</span><span class="n">haussio_data</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">sima_mc_dir</span><span class="p">):</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">dataset_mc</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mc_approach</span><span class="o">.</span><span class="n">correct</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">sima_mc_dir</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Motion correction took {0:.2f} s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span><span class="p">))</span>
        <span class="n">dataset_mc</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">sima_mc_dir</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dataset_mc</span> <span class="o">=</span> <span class="n">sima</span><span class="o">.</span><span class="n">ImagingDataset</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">sima_mc_dir</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Loaded sima dataset from &quot;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">sima_mc_dir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t load sima dataset: &quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
            <span class="n">dataset_mc</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to_sima</span><span class="p">(</span><span class="n">mc</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">filenames_mc</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;{0}{1:05d}.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">haussio_data</span><span class="o">.</span><span class="n">filetrunk</span><span class="p">,</span> <span class="n">nf</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">nf</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">haussio_data</span><span class="o">.</span><span class="n">nframes</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">maxtime</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filenames_mc</span><span class="p">)</span> <span class="o">==</span> <span class="n">dataset_mc</span><span class="o">.</span><span class="n">sequences</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filenames_mc</span><span class="p">),</span> <span class="n">dataset_mc</span><span class="o">.</span><span class="n">sequences</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="n">raw_fn</span> <span class="o">=</span> <span class="s2">&quot;Image_0001_0001.raw&quot;</span>
    <span class="k">if</span> <span class="n">compress</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;nt&#39;</span><span class="p">:</span>
        <span class="n">raw_fn</span> <span class="o">+=</span> <span class="s2">&quot;.xz&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">mc_tiff_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span>
            <span class="n">filenames_mc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">data</span><span class="o">.</span><span class="n">mc_tiff_dir</span><span class="p">,</span> <span class="n">raw_fn</span><span class="p">)):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Exporting frames...&quot;</span><span class="p">)</span>
        <span class="n">haussio</span><span class="o">.</span><span class="n">sima_export_frames</span><span class="p">(</span>
            <span class="n">dataset_mc</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">mc_tiff_dir</span><span class="p">,</span> <span class="n">filenames_mc</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s2">&quot;raw&quot;</span><span class="p">,</span>
            <span class="n">compress</span> <span class="o">=</span> <span class="p">(</span><span class="n">compress</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;nt&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">movie_mc_fn</span><span class="p">):</span>
        <span class="n">corr_movie</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">html_movie</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">movie_mc_fn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">corr_movie</span> <span class="o">=</span> <span class="n">haussio_data</span><span class="o">.</span><span class="n">make_movie_extern</span><span class="p">(</span>
            <span class="n">data</span><span class="o">.</span><span class="n">mc_tiff_dir</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="mf">14.0</span><span class="p">,</span> <span class="n">crf</span><span class="o">=</span><span class="mi">28</span><span class="p">,</span> <span class="n">width_idx</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dataset_mc</span></div>


<div class="viewcode-block" id="activity_level"><a class="viewcode-back" href="../usage/pipeline2p.html#pipeline2p.activity_level">[docs]</a><span class="k">def</span> <span class="nf">activity_level</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">infer_threshold</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">roi_subset</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the ratio of active over inactive neurons</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : ThorExperiment</span>
<span class="sd">        The ThorExperiment to be processed</span>
<span class="sd">    infer_threshold : float, optional</span>
<span class="sd">        Activity threshold of spike inference. Default: 0.15</span>
<span class="sd">    roi_subset : str</span>
<span class="sd">        Roi subset to be processed</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    level : int, int</span>
<span class="sd">        Number of active and inactive neurons</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">spikefn</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t spike inference file&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">spikefn</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

    <span class="n">spikefile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">spikefn</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="n">spikes</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">spikefile</span><span class="p">)</span>
    <span class="n">fits</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">spikefile</span><span class="p">)</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">spikefile</span><span class="p">)</span>
    <span class="n">spikefile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">active</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">nroi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">spikes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">ROI </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nroi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">spikes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="n">spikes_filt</span> <span class="o">=</span> <span class="n">spikes</span><span class="p">[</span><span class="n">nroi</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">event_ts</span> <span class="o">=</span> <span class="n">stfio</span><span class="o">.</span><span class="n">peak_detection</span><span class="p">(</span><span class="n">spikes_filt</span><span class="p">,</span> <span class="n">infer_threshold</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
        <span class="n">active</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">event_ts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2">: </span><span class="si">%d</span><span class="s2"> out of </span><span class="si">%d</span><span class="s2"> cells (</span><span class="si">%.0f%%</span><span class="s2">) are active</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">data</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">spikes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="mf">100.0</span><span class="o">*</span><span class="n">active</span><span class="o">/</span><span class="n">spikes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">active</span><span class="p">,</span> <span class="n">spikes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="process_data"><a class="viewcode-back" href="../usage/pipeline2p.html#pipeline2p.process_data">[docs]</a><span class="k">def</span> <span class="nf">process_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">base_fraction</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zscore</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute \Delta F / F_0 and detrend if required</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : numpy.ndarray</span>
<span class="sd">        Fluorescence trace, shape: (nrois, nframes)</span>
<span class="sd">    detrend : bool, optional</span>
<span class="sd">        Detrend fluorescence traces. Default: False</span>
<span class="sd">    base_fraction : float, optional</span>
<span class="sd">        Bottom fraction to be used for F_0 computation. If None, F_0 is set to</span>
<span class="sd">        data.mean(). Default: 0.05</span>
<span class="sd">    zscore : bool, optional</span>
<span class="sd">        Use z score instead of mean</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ret_data : numpy.ndarray</span>
<span class="sd">        Processed data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sortedi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ogrid</span><span class="p">[:</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">base_fraction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c1"># Sort data by brightness, select lower base_fraction:</span>
        <span class="n">sortedi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span>
            <span class="p">:,</span> <span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">base_fraction</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))]</span>

    <span class="n">Fmu</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">sortedi</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">zscore</span><span class="p">:</span>
        <span class="n">Fsig</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">sortedi</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Fsig</span> <span class="o">=</span> <span class="n">Fmu</span>

    <span class="n">Fsig</span><span class="p">[</span><span class="n">Fsig</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="c1"># Fmu and Fsig should be of shape (nrois)</span>
    <span class="c1"># data and ret_data should be of shape (nrois, nframes)</span>
    <span class="n">ret_data</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="o">-</span><span class="n">Fmu</span><span class="p">)</span><span class="o">/</span><span class="n">Fsig</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="mf">100.0</span>

    <span class="k">if</span> <span class="n">detrend</span><span class="p">:</span>
        <span class="n">ret_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span>
                <span class="n">trace</span><span class="p">,</span> <span class="n">bp</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">4.0</span><span class="p">),</span>
                           <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span><span class="p">),</span>
                           <span class="nb">int</span><span class="p">(</span><span class="mf">3.0</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">4.0</span><span class="p">),</span>
                           <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
            <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">ret_data</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">ret_data</span></div>


<div class="viewcode-block" id="xcorr"><a class="viewcode-back" href="../usage/pipeline2p.html#pipeline2p.xcorr">[docs]</a><span class="k">def</span> <span class="nf">xcorr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">roi_subset1</span><span class="o">=</span><span class="s2">&quot;DG&quot;</span><span class="p">,</span> <span class="n">roi_subset2</span><span class="o">=</span><span class="s2">&quot;CA3&quot;</span><span class="p">,</span>
          <span class="n">infer_threshold</span><span class="o">=</span><span class="mf">0.15</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute cross correlation between fluorescence extracted from two</span>
<span class="sd">    roi subsets</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : ThorExperiment</span>
<span class="sd">        The ThorExperiment to be processed</span>
<span class="sd">    chan : str</span>
<span class="sd">        Channel character</span>
<span class="sd">    roi_subset1 : str, optional</span>
<span class="sd">        Roi subset 1 suffix. Default: &quot;DG&quot;</span>
<span class="sd">    roi_subset2 : str, optional</span>
<span class="sd">        Roi subset 2 suffix. Default: &quot;CA3&quot;</span>
<span class="sd">    infer_threshold: float, optional</span>
<span class="sd">        Spike inference threshold. Default: 0.15</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    high_xcs : list of 2-tuple of ints</span>
<span class="sd">        List of roi indices with xcorr values &gt; 0.5</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">rois1</span><span class="p">,</span> <span class="n">meas1</span><span class="p">,</span> <span class="n">experiment1</span><span class="p">,</span> <span class="n">zproj1</span><span class="p">,</span> <span class="n">spikes1</span> <span class="o">=</span> \
        <span class="n">get_rois_ij</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">infer</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">rois2</span><span class="p">,</span> <span class="n">meas2</span><span class="p">,</span> <span class="n">experiment2</span><span class="p">,</span> <span class="n">zproj2</span><span class="p">,</span> <span class="n">spikes2</span> <span class="o">=</span> \
        <span class="n">get_rois_ij</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">infer</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">meas1_filt</span> <span class="o">=</span> <span class="n">process_data</span><span class="p">(</span><span class="n">meas1</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">detrend</span><span class="p">)</span>
    <span class="n">meas2_filt</span> <span class="o">=</span> <span class="n">process_data</span><span class="p">(</span><span class="n">meas2</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">detrend</span><span class="p">)</span>

    <span class="n">high_xcs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">nroi1</span><span class="p">,</span> <span class="n">m1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">meas1_filt</span><span class="p">):</span>
        <span class="n">spikes1_filt</span> <span class="o">=</span> <span class="p">(</span><span class="n">spikes1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">nroi1</span><span class="p">]</span><span class="o">-</span><span class="n">spikes1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">nroi1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">event1_ts</span> <span class="o">=</span> <span class="n">stfio</span><span class="o">.</span><span class="n">peak_detection</span><span class="p">(</span><span class="n">spikes1_filt</span><span class="p">,</span> <span class="n">infer_threshold</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">event1_ts</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">nroi2</span><span class="p">,</span> <span class="n">m2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">meas2_filt</span><span class="p">):</span>
                <span class="n">spikes2_filt</span> <span class="o">=</span> <span class="p">(</span><span class="n">spikes2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">nroi2</span><span class="p">]</span><span class="o">-</span><span class="n">spikes2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">nroi2</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">event2_ts</span> <span class="o">=</span> <span class="n">stfio</span><span class="o">.</span><span class="n">peak_detection</span><span class="p">(</span><span class="n">spikes2_filt</span><span class="p">,</span> <span class="n">infer_threshold</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">event2_ts</span><span class="p">):</span>
                    <span class="n">xc</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">matchTemplate</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">TM_CCORR_NORMED</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">xc</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
                        <span class="n">high_xcs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nroi1</span><span class="p">,</span> <span class="n">nroi2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">high_xcs</span></div>


<div class="viewcode-block" id="norm"><a class="viewcode-back" href="../usage/pipeline2p.html#pipeline2p.norm">[docs]</a><span class="k">def</span> <span class="nf">norm</span><span class="p">(</span><span class="n">sig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize data to have range [0,1]</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sig : numpy.ndarray</span>
<span class="sd">        Data to be normalized</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    norm : numpy.ndarray</span>
<span class="sd">        Normalized data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">sig</span><span class="o">-</span><span class="n">sig</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">sig</span><span class="o">.</span><span class="n">min</span><span class="p">())</span></div>


<div class="viewcode-block" id="plot_rois"><a class="viewcode-back" href="../usage/pipeline2p.html#pipeline2p.plot_rois">[docs]</a><span class="k">def</span> <span class="nf">plot_rois</span><span class="p">(</span><span class="n">rois</span><span class="p">,</span> <span class="n">measured</span><span class="p">,</span> <span class="n">haussio_data</span><span class="p">,</span> <span class="n">zproj</span><span class="p">,</span> <span class="n">data_path</span><span class="p">,</span> <span class="n">pdf_suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
              <span class="n">spikes</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">infer_threshold</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">mapdict</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
              <span class="n">lopass</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">plot_events</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">minimaps</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">1200</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot ROIs on top of z-projected image, extracted fluorescence, spike</span>
<span class="sd">    inference, fluorescence and spike inference against position (if available)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rois : sima.ROI.ROIList</span>
<span class="sd">        sima ROIList to be plotted</span>
<span class="sd">    measured : numpy.ndarray</span>
<span class="sd">        Processed fluorescence data for each ROI</span>
<span class="sd">    haussio_data : haussio.HaussIO</span>
<span class="sd">        haussio.HaussIO instance</span>
<span class="sd">    zproj : numpy.ndarray</span>
<span class="sd">        z-projected fluorescence image</span>
<span class="sd">    data_path : str</span>
<span class="sd">        Path to data directory</span>
<span class="sd">    pdf_suffix : str, optional</span>
<span class="sd">        Suffix appended to pdf. Default: &quot;&quot;</span>
<span class="sd">    spikes : numpy.ndarray, optional</span>
<span class="sd">        Spike inference values. Default: None</span>
<span class="sd">    infer_threshold: float, optional</span>
<span class="sd">        Spike inference threshold. Default: 0.15</span>
<span class="sd">    region : str, optional</span>
<span class="sd">        Brain region. Default: &quot;&quot;</span>
<span class="sd">    mapdict : dict, optional</span>
<span class="sd">        Dictionary containing processed VR data. Default: None</span>
<span class="sd">    lopass : float, optional</span>
<span class="sd">        Lowpass filter frequency for plotted traces. Default: 1.0</span>
<span class="sd">    plot_events : bool, optional</span>
<span class="sd">        Plot events. Default: False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">24</span><span class="p">))</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]</span>

    <span class="n">nrows</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">strow</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="n">mapdict</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">stcol</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stcol</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">)</span>
    <span class="n">ax_nospike</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">strow</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="n">ax_blank</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[:</span><span class="n">strow</span><span class="p">,</span> <span class="n">stcol</span><span class="p">:</span><span class="n">stcol</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax_blank</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">zproj</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">haussio_data</span><span class="o">.</span><span class="n">plot_scale_bar</span><span class="p">(</span><span class="n">ax_blank</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[:</span><span class="n">strow</span><span class="p">,</span> <span class="n">stcol</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">zproj</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">haussio_data</span><span class="o">.</span><span class="n">plot_scale_bar</span><span class="p">(</span><span class="n">ax2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="n">ax_spike</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">strow</span><span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="n">pos_spike</span><span class="p">,</span> <span class="n">pos_nospike</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">spikes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">spikes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rois</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="s2">&quot;Number of ROIs is {0}, number of spike inferences &quot;</span>
                <span class="s2">&quot;is {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rois</span><span class="p">),</span> <span class="n">spikes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="k">assert</span><span class="p">(</span><span class="n">spikes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">rois</span><span class="p">))</span>

    <span class="n">ndiscard</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">mapdict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">dtvr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;t_vr&#39;</span><span class="p">]))</span><span class="o">*</span><span class="mf">1e-3</span>
        <span class="n">ax_pos</span> <span class="o">=</span> <span class="n">stfio_plot</span><span class="o">.</span><span class="n">StandardAxis</span><span class="p">(</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="n">hasx</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax_spike</span><span class="p">)</span>
        <span class="n">ax_pos_nospike</span> <span class="o">=</span> <span class="n">stfio_plot</span><span class="o">.</span><span class="n">StandardAxis</span><span class="p">(</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">hasx</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">hasy</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">sharex</span><span class="o">=</span><span class="n">ax_nospike</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax_pos</span><span class="p">)</span>
        <span class="n">ax_pos</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;t_vr&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;posy_vr&#39;</span><span class="p">])</span>
        <span class="n">ax_pos_nospike</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;t_vr&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;posy_vr&#39;</span><span class="p">])</span>
        <span class="n">ax_pos</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;VR position (m)&quot;</span><span class="p">)</span>
        <span class="c1"># ax_pos.set_ylim(mapdict[&#39;posy_vr&#39;].min(), mapdict[&#39;posy_vr&#39;].max())</span>
        <span class="k">if</span> <span class="n">plot_events</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">evcode</span> <span class="ow">in</span> <span class="p">[</span>
                        <span class="n">b</span><span class="s1">&#39;GZ&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s1">&#39;GL&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s1">&#39;GN&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s1">&#39;GH&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s1">&#39;TP&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s1">&#39;UP&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s1">&#39;UR&#39;</span><span class="p">]:</span>
                    <span class="n">ax_pos</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                        <span class="n">ev</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">marker</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">ms</span><span class="p">)</span>
        <span class="n">ax_speed</span> <span class="o">=</span> <span class="n">stfio_plot</span><span class="o">.</span><span class="n">StandardAxis</span><span class="p">(</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="n">hasx</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax_spike</span><span class="p">)</span>
        <span class="n">ax_speed_nospike</span> <span class="o">=</span> <span class="n">stfio_plot</span><span class="o">.</span><span class="n">StandardAxis</span><span class="p">(</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">hasx</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">hasy</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">sharex</span><span class="o">=</span><span class="n">ax_nospike</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax_speed</span><span class="p">)</span>
        <span class="n">ax_speed</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;t_vr&#39;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-3</span><span class="o">+</span><span class="n">dtvr</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;speed_vr&#39;</span><span class="p">])</span>
        <span class="n">ax_speed_nospike</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;t_vr&#39;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-3</span><span class="o">+</span><span class="n">dtvr</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;speed_vr&#39;</span><span class="p">])</span>
        <span class="n">ax_speed</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Speed (m/s)&quot;</span><span class="p">)</span>
        <span class="n">ax_speed</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;speed_vr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;speed_vr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

        <span class="n">ax_maps_fluo</span> <span class="o">=</span> <span class="n">stfio_plot</span><span class="o">.</span><span class="n">StandardAxis</span><span class="p">(</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">gs</span><span class="p">[</span><span class="n">strow</span><span class="p">:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">hasx</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">hasy</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax_spike</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spikes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ax_maps_infer</span> <span class="o">=</span> <span class="n">stfio_plot</span><span class="o">.</span><span class="n">StandardAxis</span><span class="p">(</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">gs</span><span class="p">[</span><span class="n">strow</span><span class="p">:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">hasx</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">hasy</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax_spike</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">nroi</span><span class="p">,</span> <span class="n">roi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rois</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">ROI </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nroi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rois</span><span class="p">)))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lopass</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">measured_float</span> <span class="o">=</span> <span class="n">measured</span><span class="p">[</span><span class="n">nroi</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
            <span class="n">meas_filt</span> <span class="o">=</span> <span class="n">spectral</span><span class="o">.</span><span class="n">lowpass</span><span class="p">(</span>
                <span class="n">stfio_plot</span><span class="o">.</span><span class="n">Timeseries</span><span class="p">(</span><span class="n">measured_float</span><span class="p">,</span> <span class="n">haussio_data</span><span class="o">.</span><span class="n">dt</span><span class="p">),</span>
                <span class="n">lopass</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ndiscard</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">meas_filt</span> <span class="o">=</span> <span class="n">measured</span><span class="p">[</span><span class="n">nroi</span><span class="p">,</span> <span class="n">ndiscard</span><span class="p">:]</span>
        <span class="n">meas_filt</span> <span class="o">-=</span> <span class="n">meas_filt</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">nroi</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">normamp</span> <span class="o">=</span> <span class="n">meas_filt</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">meas_filt</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">roi</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">roi</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span>
                     <span class="n">colors</span><span class="p">[</span><span class="n">nroi</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)])</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">roi</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">roi</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                     <span class="s2">&quot;{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nroi</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                     <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">nroi</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)],</span>
                     <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sima</span><span class="o">.</span><span class="n">ROI</span><span class="o">.</span><span class="n">NonBooleanMask</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;NonBooleanMask&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mapdict</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">trange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">meas_filt</span><span class="p">))</span><span class="o">*</span><span class="n">haussio_data</span><span class="o">.</span><span class="n">dt</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trange</span> <span class="o">=</span> <span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;t_2p&#39;</span><span class="p">][</span><span class="n">ndiscard</span><span class="p">:]</span> <span class="o">*</span> <span class="mf">1e-3</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_spike</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">pos_spike</span>

        <span class="k">if</span> <span class="n">spikes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">spikes_filt</span> <span class="o">=</span> <span class="n">spikes</span><span class="p">[</span><span class="n">nroi</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">infer_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">event_ts</span> <span class="o">=</span> <span class="n">stfio</span><span class="o">.</span><span class="n">peak_detection</span><span class="p">(</span>
                    <span class="n">spikes_filt</span><span class="p">,</span> <span class="n">infer_threshold</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">event_ts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_nospike</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="n">pos_nospike</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">spikes_filt</span> <span class="o">-=</span> <span class="n">spikes_filt</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="n">ax_nospike</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">trange</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">spikes_filt</span><span class="p">)],</span> <span class="n">spikes_filt</span><span class="p">[</span>
                        <span class="n">ndiscard</span><span class="p">:</span><span class="n">ndiscard</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">trange</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]</span> <span class="o">/</span>
                    <span class="n">spikes_filt</span><span class="p">[</span>
                        <span class="n">ndiscard</span><span class="p">:</span><span class="n">ndiscard</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">trange</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span>
                    <span class="n">normamp</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span>
                    <span class="n">colors</span><span class="p">[</span><span class="n">nroi</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)])</span>
        <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span>
        <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">trange</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">meas_filt</span><span class="p">)],</span>
            <span class="n">meas_filt</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">trange</span><span class="p">)]</span><span class="o">-</span><span class="n">meas_filt</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">trange</span><span class="p">)]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">+</span><span class="n">pos</span><span class="p">,</span>
            <span class="n">colors</span><span class="p">[</span><span class="n">nroi</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">meas_filt</span><span class="o">-</span><span class="n">meas_filt</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">+</span><span class="n">pos</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                <span class="s2">&quot;{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nroi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">nroi</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)],</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
                <span class="n">fontweight</span><span class="o">=</span><span class="n">fontweight</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mapdict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">fluo</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;fluomap&#39;</span><span class="p">][</span><span class="n">nroi</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">normamp</span>
            <span class="n">fluo</span> <span class="o">-=</span> <span class="n">fluo</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">ax_maps_fluo</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;fluomap&#39;</span><span class="p">][</span><span class="n">nroi</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                              <span class="n">fluo</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span>
                              <span class="n">colors</span><span class="p">[</span><span class="n">nroi</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)])</span>
            <span class="k">if</span> <span class="n">spikes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">infer</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;infermap&#39;</span><span class="p">][</span><span class="n">nroi</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">normamp</span>
                <span class="n">infer</span> <span class="o">-=</span> <span class="n">infer</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="n">ax_maps_infer</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;infermap&#39;</span><span class="p">][</span><span class="n">nroi</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                   <span class="n">infer</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span>
                                   <span class="n">colors</span><span class="p">[</span><span class="n">nroi</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">infer_threshold</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">pos_spike</span> <span class="o">+=</span> <span class="n">meas_filt</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">meas_filt</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">+</span><span class="mf">1.0</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">event_ts</span><span class="p">):</span>
            <span class="n">pos_spike</span> <span class="o">+=</span> <span class="n">meas_filt</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">meas_filt</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">+</span><span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pos_nospike</span> <span class="o">+=</span> <span class="n">meas_filt</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">meas_filt</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">+</span><span class="mf">1.0</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">scalebars</span><span class="o">.</span><span class="n">add_scalebar</span><span class="p">(</span><span class="n">ax_spike</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">infer_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">scalebars</span><span class="o">.</span><span class="n">add_scalebar</span><span class="p">(</span><span class="n">ax_nospike</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">region</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">regionstr</span> <span class="o">=</span> <span class="s2">&quot;undefined region&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">regionstr</span> <span class="o">=</span> <span class="n">region</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">haussio_data</span><span class="o">.</span><span class="n">filetrunk</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">regionstr</span><span class="p">,</span>
                 <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mapdict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ax_maps_fluo</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span>
            <span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;posy_vr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;posy_vr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">ax_maps_fluo</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;VR position (m)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spikes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ax_maps_infer</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span>
                <span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;posy_vr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;posy_vr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">ax_maps_infer</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;VR position (m)&quot;</span><span class="p">)</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Saving figure...&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">data_path</span> <span class="o">+</span> <span class="s2">&quot;_rois3&quot;</span> <span class="o">+</span> <span class="n">pdf_suffix</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;done</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">minimaps</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">fig_rois_fluo</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">24</span><span class="p">))</span>
    <span class="n">fig_rois_spikes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">24</span><span class="p">))</span>
    <span class="n">ncols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">minimaps</span><span class="p">))))</span>
    <span class="n">nrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">minimaps</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">ncols</span><span class="p">)))</span>

    <span class="n">gs_fluo</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">)</span>
    <span class="n">gs_spikes</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">nroi</span><span class="p">,</span> <span class="p">(</span><span class="n">iroi</span><span class="p">,</span> <span class="n">minimaps_roi</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">minimaps</span><span class="p">):</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">nroi</span> <span class="o">%</span> <span class="n">ncols</span>
        <span class="n">row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nroi</span><span class="o">/</span><span class="n">ncols</span><span class="p">)</span>
        <span class="n">ax_fluo</span> <span class="o">=</span> <span class="n">stfio_plot</span><span class="o">.</span><span class="n">StandardAxis</span><span class="p">(</span>
            <span class="n">fig_rois_fluo</span><span class="p">,</span> <span class="n">gs_fluo</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span>
            <span class="n">hasx</span><span class="o">=</span><span class="n">nroi</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">minimaps</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">hasy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">ax_spikes</span> <span class="o">=</span> <span class="n">stfio_plot</span><span class="o">.</span><span class="n">StandardAxis</span><span class="p">(</span>
            <span class="n">fig_rois_spikes</span><span class="p">,</span> <span class="n">gs_spikes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span>
            <span class="n">hasx</span><span class="o">=</span><span class="n">nroi</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">minimaps</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">hasy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">ax_fluo</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">r&quot;{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iroi</span><span class="p">))</span>
        <span class="n">ax_spikes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">r&quot;{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iroi</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">minimap</span> <span class="ow">in</span> <span class="n">minimaps_roi</span><span class="p">:</span>
            <span class="n">minimap_fluo</span><span class="p">,</span> <span class="n">minimap_spikes</span> <span class="o">=</span> <span class="n">minimap</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ax_fluo</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">minimap_fluo</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">minimap_fluo</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">minimap_fluo</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">ax_spikes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">minimap_spikes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">minimap_spikes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">minimap_spikes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">ax_fluo</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;fluomap&#39;</span><span class="p">][</span><span class="n">iroi</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;fluomap&#39;</span><span class="p">][</span><span class="n">iroi</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;fluomap&#39;</span><span class="p">][</span><span class="n">iroi</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
            <span class="s1">&#39;-k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
        <span class="n">ax_spikes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;infermap&#39;</span><span class="p">][</span><span class="n">iroi</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;infermap&#39;</span><span class="p">][</span><span class="n">iroi</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;infermap&#39;</span><span class="p">][</span><span class="n">iroi</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
            <span class="s1">&#39;-k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
        <span class="n">ax_fluo</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span>
            <span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;posy_vr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;posy_vr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">ax_spikes</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span>
            <span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;posy_vr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;posy_vr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">ax_fluo</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;fluomap&#39;</span><span class="p">][</span><span class="n">iroi</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span>
                <span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;fluomap&#39;</span><span class="p">][</span><span class="n">iroi</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax_spikes</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;infermap&#39;</span><span class="p">][</span><span class="n">iroi</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span>
                <span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;infermap&#39;</span><span class="p">][</span><span class="n">iroi</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">fig_rois_fluo</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
        <span class="n">data_path</span> <span class="o">+</span> <span class="s2">&quot;_rois_fluo&quot;</span> <span class="o">+</span> <span class="n">pdf_suffix</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
    <span class="n">fig_rois_spikes</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
        <span class="n">data_path</span> <span class="o">+</span> <span class="s2">&quot;_rois_spikes&quot;</span> <span class="o">+</span> <span class="n">pdf_suffix</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span></div>


<div class="viewcode-block" id="infer_spikes"><a class="viewcode-back" href="../usage/pipeline2p.html#pipeline2p.infer_spikes">[docs]</a><span class="k">def</span> <span class="nf">infer_spikes</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">signal_label</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform spike inference</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dataset : sima.Imaging.Dataset</span>
<span class="sd">        Dataset to be processed</span>
<span class="sd">    signal_label : str</span>
<span class="sd">        Label of signal to be processed</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    inference : ndarray of float</span>
<span class="sd">        The inferred normalized spike count at each time-bin.  Values are</span>
<span class="sd">        normalized to the maximium value over all time-bins.</span>
<span class="sd">    fit : ndarray of float</span>
<span class="sd">        The inferred denoised fluorescence signal at each time-bin.</span>
<span class="sd">    parameters : dict</span>
<span class="sd">        Dictionary with values for &#39;sigma&#39;, &#39;gamma&#39;, and &#39;baseline&#39;.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">infer_spikes</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="n">signal_label</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">share_gamma</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">u&#39;correct&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">infer_spikes</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="n">signal_label</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">share_gamma</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">u&#39;correct&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="extract_signals"><a class="viewcode-back" href="../usage/pipeline2p.html#pipeline2p.extract_signals">[docs]</a><span class="k">def</span> <span class="nf">extract_signals</span><span class="p">(</span><span class="n">signal_label</span><span class="p">,</span> <span class="n">rois</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">haussio_data</span><span class="p">,</span> <span class="n">infer</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract fluorescence data from ROIs</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    signal_label : str</span>
<span class="sd">        Label of signal to be extracted</span>
<span class="sd">    rois : sima.ROI.ROIList</span>
<span class="sd">        sima ROIList to be plotted</span>
<span class="sd">    data : ThorExperiment</span>
<span class="sd">        The ThorExperiment to be processed</span>
<span class="sd">    haussio_data : haussio.HaussIO</span>
<span class="sd">        haussio.HaussIO instance</span>
<span class="sd">    infer : bool, optional</span>
<span class="sd">        Perform spike inference. Default: True</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    measured : numpy.ndarray</span>
<span class="sd">        Processed fluorescence data for each ROI</span>
<span class="sd">    zproj : numpy.ndarray</span>
<span class="sd">        z-projected fluorescence image</span>
<span class="sd">    spikes : numpy.ndarray</span>
<span class="sd">        Spike inference for each ROI</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dataset</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to_sima</span><span class="p">(</span><span class="n">mc</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">haussio_data</span><span class="o">=</span><span class="n">haussio_data</span><span class="p">)</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="s2">&quot;Extracting signals with label {0}... &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">signal_label</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">measured</span><span class="p">,</span> <span class="n">zproj</span> <span class="o">=</span> <span class="n">extract_rois</span><span class="p">(</span>
        <span class="n">signal_label</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">rois</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">haussio_data</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;done (took </span><span class="si">%.2f</span><span class="s2">s)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="n">measured</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">measured</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">measured</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">infer</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Inferring spikes... &quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">spikefn</span><span class="p">):</span>
            <span class="n">spikes</span><span class="p">,</span> <span class="n">fits</span><span class="p">,</span> <span class="n">parameters</span> <span class="o">=</span> <span class="n">infer_spikes</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">signal_label</span><span class="p">)</span>
            <span class="n">spikefile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">spikefn</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">spikes</span><span class="p">,</span> <span class="n">spikefile</span><span class="p">)</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">fits</span><span class="p">,</span> <span class="n">spikefile</span><span class="p">)</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">spikefile</span><span class="p">)</span>
            <span class="n">spikefile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">spikes</span> <span class="o">=</span> <span class="n">spikes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spikefile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">spikefn</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
            <span class="n">spikes</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">spikefile</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fits</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">spikefile</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">spikefile</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">spikefile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s2">&quot;done (took </span><span class="si">%.2f</span><span class="s2">s)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span><span class="p">))</span>
        <span class="n">spikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">spike</span><span class="o">-</span><span class="n">spike</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="k">for</span> <span class="n">spike</span> <span class="ow">in</span> <span class="n">spikes</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spikes</span> <span class="o">=</span> <span class="n">measured</span>

    <span class="k">return</span> <span class="n">measured</span><span class="p">,</span> <span class="n">zproj</span><span class="p">,</span> <span class="n">spikes</span></div>


<div class="viewcode-block" id="get_rois_ij"><a class="viewcode-back" href="../usage/pipeline2p.html#pipeline2p.get_rois_ij">[docs]</a><span class="k">def</span> <span class="nf">get_rois_ij</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">haussio_data</span><span class="p">,</span> <span class="n">infer</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract fluorescence data from ImageJ ROIs</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : ThorExperiment</span>
<span class="sd">        The ThorExperiment to be processed</span>
<span class="sd">    haussio_data : haussio.HaussIO</span>
<span class="sd">        haussio.HaussIO instance</span>
<span class="sd">    infer : bool, optional</span>
<span class="sd">        Perform spike inference. Default: True</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rois : sima.ROI.ROIList</span>
<span class="sd">        sima ROIList to be plotted</span>
<span class="sd">    measured : numpy.ndarray</span>
<span class="sd">        Processed fluorescence data for each ROI</span>
<span class="sd">    zproj : numpy.ndarray</span>
<span class="sd">        z-projected fluorescence image</span>
<span class="sd">    spikes : numpy.ndarray</span>
<span class="sd">        Spike inference values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">roi_path_mc</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find ImageJ ROIs in&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">roi_path_mc</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">dataset_mc</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to_sima</span><span class="p">(</span><span class="n">mc</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">haussio_data</span><span class="o">=</span><span class="n">haussio_data</span><span class="p">)</span>

    <span class="n">dataset_mc</span><span class="o">.</span><span class="n">delete_ROIs</span><span class="p">(</span><span class="s1">&#39;from_ImageJ&#39;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">roi_subset</span><span class="p">)</span>
    <span class="n">rois</span> <span class="o">=</span> <span class="n">ROIList</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">roi_path_mc</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;ImageJ&#39;</span><span class="p">)</span>
    <span class="n">dataset_mc</span><span class="o">.</span><span class="n">add_ROIs</span><span class="p">(</span><span class="n">rois</span><span class="p">,</span> <span class="s1">&#39;from_ImageJ&#39;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">roi_subset</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">roi_translate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">rois</span> <span class="o">=</span> <span class="n">rois</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">affine_transform_matrix</span><span class="p">(</span>
            <span class="n">data</span><span class="o">.</span><span class="n">roi_translate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">roi_translate</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">signal_label</span> <span class="o">=</span> <span class="s1">&#39;imagej_rois&#39;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">roi_subset</span>

    <span class="n">measured</span><span class="p">,</span> <span class="n">zproj</span><span class="p">,</span> <span class="n">spikes</span> <span class="o">=</span> <span class="n">extract_signals</span><span class="p">(</span>
        <span class="n">signal_label</span><span class="p">,</span> <span class="n">rois</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">haussio_data</span><span class="p">,</span> <span class="n">infer</span><span class="o">=</span><span class="n">infer</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rois</span><span class="p">,</span> <span class="n">measured</span><span class="p">,</span> <span class="n">zproj</span><span class="p">,</span> <span class="n">spikes</span></div>


<div class="viewcode-block" id="get_rois_sima"><a class="viewcode-back" href="../usage/pipeline2p.html#pipeline2p.get_rois_sima">[docs]</a><span class="k">def</span> <span class="nf">get_rois_sima</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">haussio_data</span><span class="p">,</span> <span class="n">infer</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract fluorescence data from ROIs that are identified</span>
<span class="sd">    by sima&#39;s stICA</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : ThorExperiment</span>
<span class="sd">        The ThorExperiment to be processed</span>
<span class="sd">    haussio_data : haussio.HaussIO</span>
<span class="sd">        haussio.HaussIO instance</span>
<span class="sd">    infer : bool, optional</span>
<span class="sd">        Perform spike inference. Default: True</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rois : sima.ROI.ROIList</span>
<span class="sd">        sima ROIList to be plotted</span>
<span class="sd">    measured : numpy.ndarray</span>
<span class="sd">        Processed fluorescence data for each ROI</span>
<span class="sd">    zproj : numpy.ndarray</span>
<span class="sd">        z-projected fluorescence image</span>
<span class="sd">    spikes : numpy.ndarray</span>
<span class="sd">        Spike inference values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dataset_mc</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to_sima</span><span class="p">(</span><span class="n">mc</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">haussio_data</span><span class="o">=</span><span class="n">haussio_data</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="s1">&#39;from_sima_stICA&#39;</span> <span class="ow">in</span> <span class="n">dataset_mc</span><span class="o">.</span><span class="n">ROIs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Running sima stICA... &quot;</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">stica_approach</span> <span class="o">=</span> <span class="n">sima</span><span class="o">.</span><span class="n">segment</span><span class="o">.</span><span class="n">STICA</span><span class="p">(</span><span class="n">components</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">stica_approach</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">sima</span><span class="o">.</span><span class="n">segment</span><span class="o">.</span><span class="n">SparseROIsFromMasks</span><span class="p">(</span><span class="n">min_size</span><span class="o">=</span><span class="mf">80.0</span><span class="p">,</span>
                                             <span class="n">n_processes</span><span class="o">=</span><span class="n">NCPUS</span><span class="p">))</span>
        <span class="n">stica_approach</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">sima</span><span class="o">.</span><span class="n">segment</span><span class="o">.</span><span class="n">SmoothROIBoundaries</span><span class="p">(</span><span class="n">n_processes</span><span class="o">=</span><span class="n">NCPUS</span><span class="p">))</span>
        <span class="n">stica_approach</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">sima</span><span class="o">.</span><span class="n">segment</span><span class="o">.</span><span class="n">MergeOverlapping</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">))</span>

        <span class="n">rois</span> <span class="o">=</span> <span class="n">dataset_mc</span><span class="o">.</span><span class="n">segment</span><span class="p">(</span><span class="n">stica_approach</span><span class="p">,</span> <span class="s1">&#39;from_sima_stICA&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;sima stICA took {0:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rois</span> <span class="o">=</span> <span class="n">dataset_mc</span><span class="o">.</span><span class="n">ROIs</span><span class="p">[</span><span class="s1">&#39;from_sima_stICA&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">roi_translate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">rois</span> <span class="o">=</span> <span class="n">rois</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">affine_transform_matrix</span><span class="p">(</span>
            <span class="n">data</span><span class="o">.</span><span class="n">roi_translate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">roi_translate</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">signal_label</span> <span class="o">=</span> <span class="s1">&#39;sima_stICA_rois&#39;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">roi_subset</span>

    <span class="n">measured</span><span class="p">,</span> <span class="n">zproj</span><span class="p">,</span> <span class="n">spikes</span> <span class="o">=</span> <span class="n">extract_signals</span><span class="p">(</span>
        <span class="n">signal_label</span><span class="p">,</span> <span class="n">rois</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">haussio_data</span><span class="p">,</span> <span class="n">infer</span><span class="o">=</span><span class="n">infer</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rois</span><span class="p">,</span> <span class="n">measured</span><span class="p">,</span> <span class="n">zproj</span><span class="p">,</span> <span class="n">spikes</span></div>


<div class="viewcode-block" id="get_rois_thunder"><a class="viewcode-back" href="../usage/pipeline2p.html#pipeline2p.get_rois_thunder">[docs]</a><span class="k">def</span> <span class="nf">get_rois_thunder</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">haussio_data</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">infer</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">speed</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nrois_init</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract fluorescence data from ROIs that are identified</span>
<span class="sd">    by thunder&#39;s ICA. If running speed is available, ROIs will</span>
<span class="sd">    be determined during running periods. Otherwise, MAXFRAMES_ICA</span>
<span class="sd">    at the beginning of the recording will be used.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : ThorExperiment</span>
<span class="sd">        The ThorExperiment to be processed</span>
<span class="sd">    haussio_data : haussio.HaussIO</span>
<span class="sd">        haussio.HaussIO instance</span>
<span class="sd">    sc : SparkContext</span>
<span class="sd">        Thunder wrapper for a Spark context</span>
<span class="sd">    infer : bool, optional</span>
<span class="sd">        Perform spike inference. Default: True</span>
<span class="sd">    speed : numpy.ndarray, optional</span>
<span class="sd">        Running speed. Default: None</span>
<span class="sd">    nrois_init: int, optional</span>
<span class="sd">        Initial estimate of the number of ROIs</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rois : sima.ROI.ROIList</span>
<span class="sd">        sima ROIList to be plotted</span>
<span class="sd">    measured : numpy.ndarray</span>
<span class="sd">        Processed fluorescence data for each ROI</span>
<span class="sd">    zproj : numpy.ndarray</span>
<span class="sd">        z-projected fluorescence image</span>
<span class="sd">    spikes : numpy.ndarray</span>
<span class="sd">        Spike inference values</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Produce a z projection first so that we don&#39;t run out of memory later</span>
    <span class="n">dataset_mc</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to_sima</span><span class="p">(</span><span class="n">mc</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">haussio_data</span><span class="o">=</span><span class="n">haussio_data</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset_mc</span><span class="o">.</span><span class="n">frame_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">proj_fn</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Compute z projection...&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">zproj</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">zproject</span><span class="p">(</span><span class="n">haussio_data</span><span class="o">.</span><span class="n">read_raw</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">proj_fn</span><span class="p">,</span> <span class="n">zproj</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;done</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">thunder_roiraw_fn</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data_path_comp</span> <span class="o">+</span> <span class="s2">&quot;_thunder_rois.npy&quot;</span>

    <span class="n">maxframes_ica</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">MAXFRAMES_ICA</span><span class="o">/</span><span class="p">(</span>
        <span class="n">haussio_data</span><span class="o">.</span><span class="n">xpx</span><span class="o">*</span><span class="n">haussio_data</span><span class="o">.</span><span class="n">ypx</span><span class="o">/</span><span class="p">(</span><span class="mf">512.0</span><span class="o">*</span><span class="mf">512.0</span><span class="p">)))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">thunder_roiraw_fn</span><span class="p">):</span>
        <span class="c1"># Find longest contiguous running region:</span>
        <span class="k">if</span> <span class="n">speed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">assert</span><span class="p">(</span><span class="n">haussio_data</span><span class="o">.</span><span class="n">nframes</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">speed</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;nframes, nspeed: &quot;</span><span class="p">,</span> <span class="n">haussio_data</span><span class="o">.</span><span class="n">nframes</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">speed</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">err</span>

            <span class="c1"># find startIdx that maximizes the median speed over maxframes_ica</span>
            <span class="n">maxstart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span>
                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">speed</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="n">maxframes_ica</span><span class="p">])</span>
                 <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span><span class="o">-</span><span class="n">maxframes_ica</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">maxstart</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="kn">from</span> <span class="nn">thunder</span> <span class="kn">import</span> <span class="n">images</span>
        <span class="kn">from</span> <span class="nn">thunder</span> <span class="kn">import</span> <span class="n">series</span>
        <span class="kn">from</span> <span class="nn">factorization</span> <span class="kn">import</span> <span class="n">ICA</span>

        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Reading files into thunder... &quot;</span><span class="p">)</span>

        <span class="n">rawarray</span> <span class="o">=</span> <span class="n">haussio_data</span><span class="o">.</span><span class="n">read_raw</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rawarray</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">rawarray</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">rawarray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rawarray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rawarray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">data_series</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span>
            <span class="n">haussio_data</span><span class="o">.</span><span class="n">read_raw</span><span class="p">()[</span><span class="n">maxstart</span><span class="p">:</span><span class="n">maxstart</span><span class="o">+</span><span class="n">maxframes_ica</span><span class="p">],</span>
            <span class="n">engine</span><span class="o">=</span><span class="n">sc</span><span class="p">)</span><span class="o">.</span><span class="n">toseries</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">data_series</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
        <span class="n">data_series</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Running thunder ICA... &quot;</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">W</span><span class="p">,</span> <span class="n">sigs</span><span class="p">,</span> <span class="n">A</span> <span class="o">=</span> <span class="n">ICA</span><span class="p">(</span>
            <span class="n">k</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">nrois_init</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">k_pca</span><span class="o">=</span><span class="n">nrois_init</span><span class="p">,</span> <span class="n">svd_method</span><span class="o">=</span><span class="s1">&#39;em&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                <span class="n">data_series</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Thunder ICA took {0:.2f} s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span><span class="p">))</span>

        <span class="n">imgs</span> <span class="o">=</span> <span class="n">sigs</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>

        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">thunder_roiraw_fn</span><span class="p">,</span> <span class="n">imgs</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="n">imgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">thunder_roiraw_fn</span><span class="p">)</span>

    <span class="n">imgs</span> <span class="o">=</span> <span class="n">imgs</span><span class="o">.</span><span class="n">T</span>
    <span class="n">imgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="p">(</span>
        <span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dataset_mc</span><span class="o">.</span><span class="n">frame_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dataset_mc</span><span class="o">.</span><span class="n">frame_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="n">thunder_roi_fn</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data_path_comp</span> <span class="o">+</span> <span class="s2">&quot;_rois_thunder.pkl&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">thunder_roi_fn</span><span class="p">):</span>
        <span class="n">rois</span> <span class="o">=</span> <span class="n">ROIList</span><span class="p">([</span><span class="n">sima</span><span class="o">.</span><span class="n">ROI</span><span class="o">.</span><span class="n">ROI</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">imgs</span><span class="p">])</span>

        <span class="n">sparsify</span> <span class="o">=</span> <span class="n">sima</span><span class="o">.</span><span class="n">segment</span><span class="o">.</span><span class="n">SparseROIsFromMasks</span><span class="p">(</span>
            <span class="n">min_size</span><span class="o">=</span><span class="mf">80.0</span><span class="p">,</span> <span class="n">n_processes</span><span class="o">=</span><span class="n">NCPUS</span><span class="p">)</span>
        <span class="n">smoothen</span> <span class="o">=</span> <span class="n">sima</span><span class="o">.</span><span class="n">segment</span><span class="o">.</span><span class="n">SmoothROIBoundaries</span><span class="p">(</span><span class="n">n_processes</span><span class="o">=</span><span class="n">NCPUS</span><span class="p">)</span>
        <span class="n">merge</span> <span class="o">=</span> <span class="n">sima</span><span class="o">.</span><span class="n">segment</span><span class="o">.</span><span class="n">MergeOverlapping</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">remove_lines</span> <span class="o">=</span> <span class="n">sima</span><span class="o">.</span><span class="n">segment</span><span class="o">.</span><span class="n">ROIFilter</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">roi</span><span class="p">:</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">roi</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">roi</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span>
                <span class="p">(</span><span class="n">roi</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">roi</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mf">0.125</span><span class="p">))</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Postprocessing... &quot;</span><span class="p">)</span>
        <span class="c1"># rois = remove_lines.apply(</span>
        <span class="n">rois</span> <span class="o">=</span> <span class="n">merge</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="n">smoothen</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="n">sparsify</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">rois</span><span class="p">)))</span> <span class="c1"># )</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Postprocessing took {:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span><span class="p">))</span>
        <span class="n">rois</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">thunder_roi_fn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rois</span> <span class="o">=</span> <span class="n">ROIList</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">thunder_roi_fn</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">roi_translate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">rois</span> <span class="o">=</span> <span class="n">rois</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">affine_transform_matrix</span><span class="p">(</span>
            <span class="n">data</span><span class="o">.</span><span class="n">roi_translate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">roi_translate</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">dataset_mc</span><span class="o">.</span><span class="n">delete_ROIs</span><span class="p">(</span><span class="s1">&#39;from_thunder_ICA&#39;</span><span class="p">)</span>
    <span class="n">dataset_mc</span><span class="o">.</span><span class="n">add_ROIs</span><span class="p">(</span><span class="n">rois</span><span class="p">,</span> <span class="s1">&#39;from_thunder_ICA&#39;</span><span class="p">)</span>

    <span class="n">signal_label</span> <span class="o">=</span> <span class="s1">&#39;thunder_ICA_rois&#39;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">roi_subset</span>

    <span class="n">measured</span><span class="p">,</span> <span class="n">zproj</span><span class="p">,</span> <span class="n">spikes</span> <span class="o">=</span> <span class="n">extract_signals</span><span class="p">(</span>
        <span class="n">signal_label</span><span class="p">,</span> <span class="n">rois</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">haussio_data</span><span class="p">,</span> <span class="n">infer</span><span class="o">=</span><span class="n">infer</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rois</span><span class="p">,</span> <span class="n">measured</span><span class="p">,</span> <span class="n">zproj</span><span class="p">,</span> <span class="n">spikes</span></div>


<div class="viewcode-block" id="get_vr_maps"><a class="viewcode-back" href="../usage/pipeline2p.html#pipeline2p.get_vr_maps">[docs]</a><span class="k">def</span> <span class="nf">get_vr_maps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">measured</span><span class="p">,</span> <span class="n">spikes</span><span class="p">,</span> <span class="n">vrdict</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read and assemble VR data</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : ThorExperiment</span>
<span class="sd">        The ThorExperiment to be processed</span>
<span class="sd">    measured : numpy.ndarray</span>
<span class="sd">        Processed fluorescence data for each ROI</span>
<span class="sd">    spikes : numpy.ndarray</span>
<span class="sd">        Spike inference values</span>
<span class="sd">    vrdict : dict</span>
<span class="sd">        Dictionary with processed VR data</span>
<span class="sd">    method : str</span>
<span class="sd">        Method that was used to extract ROIs</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mapdict : dict</span>
<span class="sd">        Dictionary with processed VR data. Contains:</span>

<span class="sd">        &quot;t_2p&quot;: Time points of 2p frames, shape (nt2p)</span>

<span class="sd">        &quot;DFoF_2p&quot;: Fluorescence for each roi, shape (nrois, nt2p)</span>

<span class="sd">        &quot;spikes_2p&quot;: Spike inference values for each roi, shape (nrois, nt2p)</span>

<span class="sd">        &quot;t_vr&quot;: Time points of VR values, shape (ntvr)</span>

<span class="sd">        &quot;posy_vr&quot;: Position in VR along y, shape (ntvr)</span>

<span class="sd">        &quot;speed_vr&quot;: Speed in VR, shape (ntvr)</span>

<span class="sd">        &quot;events&quot;: List of events, each containing the time of the </span>
<span class="sd">        event (event.time) and a 2-character event code (event.code)</span>

<span class="sd">        &quot;t_ev_matlab&quot;: List of event times for processing with MATLAB</span>

<span class="sd">        &quot;events_matlab&quot;: Numerical event codes for processing with MATLAB</span>

<span class="sd">        &quot;fluomap&quot;: Fluorescence values against space, shape (nrois, 2)</span>

<span class="sd">        fluomap[:, 0] is position along y</span>

<span class="sd">        fluomap[:, 1] is fluorescence along y</span>

<span class="sd">        &quot;infermap&quot;: Spike inference values against space, shape (nrois, 2)</span>

<span class="sd">        infermap[:, 0] is position along y</span>

<span class="sd">        infermap[:, 1] is fluorescence along y</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">syncfiles</span>
    <span class="kn">import</span> <span class="nn">imp</span>
    <span class="n">imp</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">syncfiles</span><span class="p">)</span>
    <span class="n">imp</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">syncfiles</span><span class="o">.</span><span class="n">haussmeister</span><span class="p">)</span>

    <span class="n">matlab_evcodes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">b</span><span class="s1">&#39;GZ&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s1">&#39;GL&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s1">&#39;GN&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s1">&#39;GH&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s1">&#39;TP&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s1">&#39;UP&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s1">&#39;UR&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s1">&#39;SR&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s1">&#39;SM&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">fnvr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">fluomap</span><span class="p">,</span> <span class="n">infermap</span> <span class="o">=</span> <span class="n">syncfiles</span><span class="o">.</span><span class="n">create_maps_2p</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">measured</span><span class="p">,</span> <span class="n">spikes</span><span class="p">,</span> <span class="n">vrdict</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
        <span class="n">t_ev_matlab</span> <span class="o">=</span> <span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">time</span> <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;evlist&quot;</span><span class="p">]</span>
                       <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">evcode</span> <span class="ow">in</span> <span class="n">matlab_evcodes</span><span class="p">]</span>
        <span class="n">events_matlab</span> <span class="o">=</span> <span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">evcode</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;evlist&quot;</span><span class="p">]</span>
                         <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">evcode</span> <span class="ow">in</span> <span class="n">matlab_evcodes</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">infermap</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">infermap</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mapdict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;t_2p&quot;</span><span class="p">:</span> <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;framet2p&quot;</span><span class="p">],</span>
            <span class="s2">&quot;DFoF_2p&quot;</span><span class="p">:</span> <span class="n">measured</span><span class="p">,</span>
            <span class="s2">&quot;spikes_2p&quot;</span><span class="p">:</span> <span class="n">spikes</span><span class="p">,</span>
            <span class="s2">&quot;t_vr&quot;</span><span class="p">:</span> <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;frametvr&quot;</span><span class="p">],</span>
            <span class="s2">&quot;posy_vr&quot;</span><span class="p">:</span> <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;posy&quot;</span><span class="p">],</span>
            <span class="s2">&quot;speed_vr&quot;</span><span class="p">:</span> <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;speedvr&quot;</span><span class="p">],</span>
            <span class="s2">&quot;events&quot;</span><span class="p">:</span> <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;evlist&quot;</span><span class="p">],</span>
            <span class="s2">&quot;t_ev_matlab&quot;</span><span class="p">:</span> <span class="n">t_ev_matlab</span><span class="p">,</span>
            <span class="s2">&quot;events_matlab&quot;</span><span class="p">:</span> <span class="n">events_matlab</span><span class="p">,</span>
            <span class="s1">&#39;fluomap&#39;</span><span class="p">:</span> <span class="n">fluomap</span><span class="p">,</span>
            <span class="s1">&#39;infermap&#39;</span><span class="p">:</span> <span class="n">infermap</span><span class="p">}</span>
        <span class="n">savemat</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data_path_comp</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">method</span> <span class="o">+</span> <span class="s2">&quot;_maps.mat&quot;</span><span class="p">,</span> <span class="n">mapdict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mapdict</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span></div>


<div class="viewcode-block" id="thor_extract_roi"><a class="viewcode-back" href="../usage/pipeline2p.html#pipeline2p.thor_extract_roi">[docs]</a><span class="k">def</span> <span class="nf">thor_extract_roi</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sc</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">infer</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">infer_threshold</span><span class="o">=</span><span class="mf">0.15</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract and process fluorescence data from ROIs</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : ThorExperiment</span>
<span class="sd">        The ThorExperiment to be processed</span>
<span class="sd">    sc : SparkContext</span>
<span class="sd">        A SparkContext</span>
<span class="sd">    infer : bool, optional</span>
<span class="sd">        Perform spike inference. Default: True</span>
<span class="sd">    infer_threshold : float, optional</span>
<span class="sd">        Activity threshold of spike inference. Default: 0.15</span>
<span class="sd">    nrois_init : int, optional</span>
<span class="sd">        Initial estimate of number of ROIs. Default: 200</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">seg_method</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;thunder&quot;</span><span class="p">,</span> <span class="s2">&quot;sima&quot;</span><span class="p">,</span> <span class="s2">&quot;ij&quot;</span><span class="p">,</span> <span class="s2">&quot;cnmf&quot;</span><span class="p">])</span>

    <span class="kn">import</span> <span class="nn">syncfiles</span>
    <span class="kn">import</span> <span class="nn">imp</span>
    <span class="n">imp</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">syncfiles</span><span class="p">)</span>
    <span class="n">imp</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">syncfiles</span><span class="o">.</span><span class="n">haussmeister</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">fnvr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">vrdict</span><span class="p">,</span> <span class="n">haussio_data</span> <span class="o">=</span> <span class="n">syncfiles</span><span class="o">.</span><span class="n">read_files_2p</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">vrspeed</span> <span class="o">=</span> <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;speed2p&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vrdict</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">vrspeed</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">lopass</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">seg_method</span> <span class="o">==</span> <span class="s2">&quot;thunder&quot;</span><span class="p">:</span>
        <span class="n">rois</span><span class="p">,</span> <span class="n">measured</span><span class="p">,</span> <span class="n">zproj</span><span class="p">,</span> <span class="n">spikes</span> <span class="o">=</span> <span class="n">get_rois_thunder</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">haussio_data</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">infer</span><span class="p">,</span> <span class="n">speed</span><span class="o">=</span><span class="n">vrspeed</span><span class="p">,</span>
            <span class="n">nrois_init</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">nrois_init</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">seg_method</span> <span class="o">==</span> <span class="s2">&quot;sima&quot;</span><span class="p">:</span>
        <span class="n">rois</span><span class="p">,</span> <span class="n">measured</span><span class="p">,</span> <span class="n">zproj</span><span class="p">,</span> <span class="n">spikes</span> <span class="o">=</span> <span class="n">get_rois_sima</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">haussio_data</span><span class="p">,</span> <span class="n">infer</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">seg_method</span> <span class="o">==</span> <span class="s2">&quot;ij&quot;</span><span class="p">:</span>
        <span class="n">rois</span><span class="p">,</span> <span class="n">measured</span><span class="p">,</span> <span class="n">zproj</span><span class="p">,</span> <span class="n">spikes</span> <span class="o">=</span> <span class="n">get_rois_ij</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">haussio_data</span><span class="p">,</span> <span class="n">infer</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">seg_method</span> <span class="o">==</span> <span class="s2">&quot;cnmf&quot;</span><span class="p">:</span>
        <span class="n">speed_thr</span> <span class="o">=</span> <span class="mf">0.01</span>  <span class="c1"># m/s</span>
        <span class="n">time_thr</span> <span class="o">=</span> <span class="mf">5000.0</span>  <span class="c1"># ms</span>
        <span class="n">rois</span><span class="p">,</span> <span class="n">measured</span><span class="p">,</span> <span class="n">zproj</span><span class="p">,</span> <span class="n">spikes</span><span class="p">,</span> <span class="n">vrdict</span> <span class="o">=</span> <span class="n">get_rois_cnmf</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">haussio_data</span><span class="p">,</span> <span class="n">vrdict</span><span class="p">,</span> <span class="n">speed_thr</span><span class="p">,</span> <span class="n">time_thr</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">nrois_init</span><span class="p">)</span>
        <span class="n">lopass</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">fnvr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">mapdict</span> <span class="o">=</span> <span class="n">get_vr_maps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">measured</span><span class="p">,</span> <span class="n">spikes</span><span class="p">,</span> <span class="n">vrdict</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">seg_method</span><span class="p">)</span>

        <span class="n">fnmini</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">vr_path_comp</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">seg_method</span> <span class="o">+</span> <span class="s2">&quot;_minimaps.pck&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fnmini</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Computing spatial maps...&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">minimaps</span> <span class="o">=</span> <span class="n">create_mini_maps</span><span class="p">(</span><span class="n">measured</span><span class="p">,</span> <span class="n">spikes</span><span class="p">,</span> <span class="n">mapdict</span><span class="p">,</span> <span class="n">vrdict</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fnmini</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pckf</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">minimaps</span><span class="p">,</span> <span class="n">pckf</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; done</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Loading from &quot;</span> <span class="o">+</span> <span class="n">fnmini</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fnmini</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pckf</span><span class="p">:</span>
                <span class="n">minimaps</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pckf</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; done</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mapdict</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">minimaps</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">plot_rois</span><span class="p">(</span><span class="n">rois</span><span class="p">,</span> <span class="n">measured</span><span class="p">,</span> <span class="n">haussio_data</span><span class="p">,</span> <span class="n">zproj</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">data_path_comp</span><span class="p">,</span>
              <span class="n">pdf_suffix</span><span class="o">=</span><span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">seg_method</span><span class="p">,</span> <span class="n">spikes</span><span class="o">=</span><span class="n">spikes</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">area2p</span><span class="p">,</span>
              <span class="n">infer_threshold</span><span class="o">=</span><span class="n">infer_threshold</span><span class="p">,</span> <span class="n">mapdict</span><span class="o">=</span><span class="n">mapdict</span><span class="p">,</span> <span class="n">lopass</span><span class="o">=</span><span class="n">lopass</span><span class="p">,</span>
              <span class="n">minimaps</span><span class="o">=</span><span class="n">minimaps</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">create_roi_map</span><span class="p">(</span><span class="n">iroi</span><span class="p">,</span> <span class="n">teleport_times</span><span class="p">,</span> <span class="n">measured</span><span class="p">,</span> <span class="n">spikes</span><span class="p">,</span> <span class="n">vrdict</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">syncfiles</span>
    <span class="kn">import</span> <span class="nn">imp</span>
    <span class="n">imp</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">syncfiles</span><span class="p">)</span>
    <span class="n">imp</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">syncfiles</span><span class="o">.</span><span class="n">haussmeister</span><span class="p">)</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">Computing minimap for ROI# {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iroi</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">minimaps_roi</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">teleport_times</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">teleport_times</span><span class="p">):</span>
        <span class="n">mask2p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;framet2p&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="o">*</span><span class="mf">1e3</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;framet2p&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">end</span><span class="o">*</span><span class="mf">1e3</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">maskvr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;frametvr&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="o">*</span><span class="mf">1e3</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;frametvr&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">end</span><span class="o">*</span><span class="mf">1e3</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">vrdict_mini</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;posx&quot;</span><span class="p">:</span> <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;posx&quot;</span><span class="p">][</span><span class="n">maskvr</span><span class="p">],</span>
            <span class="s2">&quot;posy&quot;</span><span class="p">:</span> <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;posy&quot;</span><span class="p">][</span><span class="n">maskvr</span><span class="p">],</span>
            <span class="s2">&quot;frametvr&quot;</span><span class="p">:</span> <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;frametvr&quot;</span><span class="p">][</span><span class="n">maskvr</span><span class="p">],</span>
            <span class="s2">&quot;speedvr&quot;</span><span class="p">:</span> <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;speedvr&quot;</span><span class="p">][</span><span class="n">maskvr</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;framet2p&quot;</span><span class="p">:</span> <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;framet2p&quot;</span><span class="p">][</span><span class="n">mask2p</span><span class="p">],</span>
            <span class="s2">&quot;speed2p&quot;</span><span class="p">:</span> <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;speed2p&quot;</span><span class="p">][</span><span class="n">mask2p</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">minimaps_roi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">syncfiles</span><span class="o">.</span><span class="n">create_maps_2p</span><span class="p">(</span>
            <span class="bp">None</span><span class="p">,</span> <span class="p">[</span><span class="n">measured</span><span class="p">[</span><span class="n">iroi</span><span class="p">][</span><span class="n">mask2p</span><span class="p">]],</span> <span class="p">[</span><span class="n">spikes</span><span class="p">[</span><span class="n">iroi</span><span class="p">][</span><span class="n">mask2p</span><span class="p">]],</span>
            <span class="n">vrdict_mini</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">iroi</span><span class="p">,</span> <span class="n">minimaps_roi</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">create_mini_maps</span><span class="p">(</span><span class="n">measured</span><span class="p">,</span> <span class="n">spikes</span><span class="p">,</span> <span class="n">mapdict</span><span class="p">,</span> <span class="n">vrdict</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">syncfiles</span>
    <span class="kn">import</span> <span class="nn">imp</span>
    <span class="n">imp</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">syncfiles</span><span class="p">)</span>
    <span class="n">imp</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">syncfiles</span><span class="o">.</span><span class="n">haussmeister</span><span class="p">)</span>

    <span class="n">iroi_with_peaks</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">mapdict</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Found {0}/{1} ROIs with spatial peaks</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">iroi_with_peaks</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;fluomap&#39;</span><span class="p">])))</span>
    <span class="n">teleport_times</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ev</span><span class="o">.</span><span class="n">time</span> <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">evcode</span> <span class="o">==</span> <span class="n">b</span><span class="s1">&#39;TP&#39;</span><span class="p">]</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">map_function</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
        <span class="n">create_roi_map</span><span class="p">,</span> <span class="n">teleport_times</span><span class="o">=</span><span class="n">teleport_times</span><span class="p">,</span> <span class="n">measured</span><span class="o">=</span><span class="n">measured</span><span class="p">,</span>
        <span class="n">spikes</span><span class="o">=</span><span class="n">spikes</span><span class="p">,</span> <span class="n">vrdict</span><span class="o">=</span><span class="n">vrdict</span><span class="p">)</span>
    <span class="n">minimaps</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">map_function</span><span class="p">,</span> <span class="n">iroi_with_peaks</span><span class="p">)</span>

    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">minimaps</span>


<span class="k">def</span> <span class="nf">running_mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,))</span><span class="o">/</span><span class="n">N</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">find_peaks</span><span class="p">(</span><span class="n">mapdict</span><span class="p">,</span> <span class="n">zscore</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">nroi</span> <span class="k">for</span> <span class="n">nroi</span><span class="p">,</span> <span class="p">(</span><span class="n">fluomap</span><span class="p">,</span> <span class="n">infermap</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;fluomap&#39;</span><span class="p">],</span> <span class="n">mapdict</span><span class="p">[</span><span class="s1">&#39;infermap&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">running_mean</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">fluomap</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span>
        <span class="n">zscore</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">fluomap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="ow">or</span>
        <span class="n">running_mean</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">infermap</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span>
        <span class="n">zscore</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">infermap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="p">]</span>


<div class="viewcode-block" id="eta"><a class="viewcode-back" href="../usage/pipeline2p.html#pipeline2p.eta">[docs]</a><span class="k">def</span> <span class="nf">eta</span><span class="p">(</span><span class="n">measured</span><span class="p">,</span> <span class="n">vrdict</span><span class="p">,</span> <span class="n">evcodelist</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute event-triggered average of fluorescence data</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    measured : numpy.ndarray</span>
<span class="sd">        Processed fluorescence data for each ROI</span>
<span class="sd">    vrdict : dict</span>
<span class="sd">        Dictionary with processed VR data</span>
<span class="sd">    evcodelist : list of str</span>
<span class="sd">        List of event types to trigger on</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pre_sd</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="n">post_sd</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">nev</span><span class="p">,</span> <span class="n">evcode</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">evcodelist</span><span class="p">):</span>
        <span class="n">nsub</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">evcodelist</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">nev</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">nsub</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">tpre</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">tpost</span> <span class="o">=</span> <span class="mf">4.0</span>
        <span class="n">evtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">nocc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">roilist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">vrdict</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">evcode</span> <span class="o">==</span> <span class="n">evcode</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">time</span><span class="o">-</span><span class="n">evtime</span> <span class="o">&gt;</span> <span class="mf">0.25</span><span class="p">):</span>
                <span class="n">evtime</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">time</span>
                <span class="n">t0</span> <span class="o">=</span> <span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">time</span><span class="o">-</span><span class="n">tpre</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e3</span>
                <span class="n">te</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">time</span> <span class="o">*</span> <span class="mf">1e3</span>
                <span class="n">tf</span> <span class="o">=</span> <span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">time</span><span class="o">+</span><span class="mf">1.5</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e3</span>
                <span class="k">for</span> <span class="n">nm</span><span class="p">,</span> <span class="n">meas</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">measured</span><span class="p">):</span>
                    <span class="n">fluorange_pre</span> <span class="o">=</span> <span class="n">meas</span><span class="p">[</span>
                        <span class="p">(</span><span class="n">vrdict</span><span class="p">[</span><span class="s1">&#39;t_2p&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&amp;</span>
                        <span class="p">(</span><span class="n">vrdict</span><span class="p">[</span><span class="s1">&#39;t_2p&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">te</span><span class="p">)]</span>
                    <span class="n">fluorange_find</span> <span class="o">=</span> <span class="n">meas</span><span class="p">[</span>
                        <span class="p">(</span><span class="n">vrdict</span><span class="p">[</span><span class="s1">&#39;t_2p&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">te</span><span class="p">)</span> <span class="o">&amp;</span>
                        <span class="p">(</span><span class="n">vrdict</span><span class="p">[</span><span class="s1">&#39;t_2p&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tf</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="n">fluorange_find</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">meas</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">+</span><span class="n">post_sd</span><span class="o">*</span><span class="n">meas</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="ow">and</span> \
                       <span class="n">fluorange_pre</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">meas</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">+</span><span class="n">pre_sd</span><span class="o">*</span><span class="n">meas</span><span class="o">.</span><span class="n">std</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">nocc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">roilist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nm</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">nm</span> <span class="ow">in</span> <span class="n">roilist</span><span class="p">:</span>
                            <span class="n">roilist</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">nm</span><span class="p">)</span>
                <span class="n">nocc</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">print</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">roilist</span><span class="p">),</span> <span class="n">roilist</span><span class="p">)</span>
        <span class="n">evtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">vrdict</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">evcode</span> <span class="o">==</span> <span class="n">evcode</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">time</span><span class="o">-</span><span class="n">evtime</span> <span class="o">&gt;</span> <span class="mf">0.25</span><span class="p">):</span>
                <span class="n">evtime</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">time</span>
                <span class="n">t0</span> <span class="o">=</span> <span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">time</span><span class="o">-</span><span class="n">tpre</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e3</span>
                <span class="n">t1</span> <span class="o">=</span> <span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">time</span><span class="o">+</span><span class="n">tpost</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e3</span>
                <span class="n">trange</span> <span class="o">=</span> <span class="n">vrdict</span><span class="p">[</span><span class="s1">&#39;t_2p&#39;</span><span class="p">][</span>
                    <span class="p">(</span><span class="n">vrdict</span><span class="p">[</span><span class="s1">&#39;t_2p&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="n">vrdict</span><span class="p">[</span><span class="s1">&#39;t_2p&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">t1</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">nm</span><span class="p">,</span> <span class="n">meas</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">measured</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">nm</span> <span class="ow">in</span> <span class="n">roilist</span><span class="p">:</span>
                        <span class="n">fluorange</span> <span class="o">=</span> <span class="n">meas</span><span class="p">[</span>
                            <span class="p">(</span><span class="n">vrdict</span><span class="p">[</span><span class="s1">&#39;t_2p&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&amp;</span>
                            <span class="p">(</span><span class="n">vrdict</span><span class="p">[</span><span class="s1">&#39;t_2p&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">t1</span><span class="p">)]</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trange</span><span class="o">-</span><span class="n">trange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fluorange</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tpre</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span> <span class="o">-</span><span class="mf">50.0</span><span class="p">,</span> <span class="s1">&#39;ok&#39;</span><span class="p">)</span>

    <span class="n">scalebars</span><span class="o">.</span><span class="n">add_scalebar</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">thor_gain_roi_ij</span><span class="p">(</span><span class="n">exp_list</span><span class="p">,</span> <span class="n">infer</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">infer_threshold</span><span class="o">=</span><span class="mf">0.15</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">exp_list</span><span class="p">:</span>
        <span class="n">rois</span><span class="p">,</span> <span class="n">measured</span><span class="p">,</span> <span class="n">haussio_data</span><span class="p">,</span> <span class="n">zproj</span><span class="p">,</span> <span class="n">spikes</span> <span class="o">=</span> \
            <span class="n">get_rois_ij</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">infer</span><span class="p">)</span>

        <span class="n">vrdict</span> <span class="o">=</span> <span class="n">get_vr_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">measured</span><span class="p">,</span> <span class="n">spikes</span><span class="p">)</span>

        <span class="n">eta</span><span class="p">(</span><span class="n">measured</span><span class="p">,</span> <span class="n">vrdict</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="s1">&#39;TP&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s1">&#39;GZ&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s1">&#39;GH&#39;</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">compare_rois</span><span class="p">(</span><span class="n">rois1</span><span class="p">,</span> <span class="n">rois2</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rois1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rois2</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="c1"># for roi1, roi2 in zip(rois1, rois2):</span>
    <span class="c1">#     try:</span>
    <span class="c1">#         roi1.coords</span>
    <span class="c1">#         roi2.coords</span>
    <span class="c1">#     except AttributeError:</span>
    <span class="c1">#         return False</span>
    <span class="c1">#     if roi1.coords != roi2.coords:</span>
    <span class="c1">#         return False</span>

    <span class="k">return</span> <span class="bp">True</span>


<div class="viewcode-block" id="extract_rois"><a class="viewcode-back" href="../usage/pipeline2p.html#pipeline2p.extract_rois">[docs]</a><span class="k">def</span> <span class="nf">extract_rois</span><span class="p">(</span><span class="n">signal_label</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">rois</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">haussio_data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract fluorescence data from ROIs</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    signal_label : str</span>
<span class="sd">        Label of signal to be extracted</span>
<span class="sd">    dataset : sima.Imaging.Dataset</span>
<span class="sd">        sima dataset</span>
<span class="sd">    rois : sima.ROI.ROIList</span>
<span class="sd">        sima ROIList</span>
<span class="sd">    data : ThorExperiment</span>
<span class="sd">        The ThorExperiment to be processed</span>
<span class="sd">    haussio_data : haussio.HaussIO</span>
<span class="sd">        haussio.HaussIO instance</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    measured : numpy.ndarray</span>
<span class="sd">        Processed fluorescence data for each ROI</span>
<span class="sd">    zproj : numpy.ndarray</span>
<span class="sd">        z-projected fluorescence image</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">signal_label</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">signals</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">signals</span><span class="p">()[</span><span class="n">signal_label</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">compare_rois</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">signals</span><span class="p">()[</span><span class="n">signal_label</span><span class="p">][</span><span class="s1">&#39;rois&#39;</span><span class="p">],</span>
                            <span class="n">rois</span><span class="p">):</span>
            <span class="n">signals</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">rois</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">signal_label</span><span class="p">,</span>
                                      <span class="n">save_summary</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">n_processes</span><span class="o">=</span><span class="n">NCPUS</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">rois</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">signal_label</span><span class="p">,</span>
                                  <span class="n">save_summary</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">n_processes</span><span class="o">=</span><span class="n">NCPUS</span><span class="p">)</span>

    <span class="n">measured</span> <span class="o">=</span> <span class="n">process_data</span><span class="p">(</span><span class="n">signals</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">detrend</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">detrend</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">proj_fn</span><span class="p">):</span>
        <span class="n">zproj</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">zproject</span><span class="p">(</span><span class="n">haussio_data</span><span class="o">.</span><span class="n">read_raw</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">proj_fn</span><span class="p">,</span> <span class="n">zproj</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">zproj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">proj_fn</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">measured</span><span class="p">,</span> <span class="n">zproj</span></div>


<span class="k">class</span> <span class="nc">Bardata</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">bar1_color</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="n">mean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">err</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">color</span>


<span class="k">def</span> <span class="nf">make_bardata</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Bardata</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">err</span><span class="o">=</span><span class="n">stats</span><span class="o">.</span><span class="n">sem</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                   <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">bargraph</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">labelpos</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">paired</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
             <span class="n">xdata</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">bar</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>

    <span class="n">xret</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">paired</span><span class="p">:</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">datasets</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">xdata</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># xticks = []</span>
    <span class="c1"># xpos = []</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">xys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e9</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="mf">2e9</span>
    <span class="k">for</span> <span class="n">ndata</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">datasets</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">xdata</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">+=</span> <span class="n">gap2</span>
            <span class="n">boffset</span> <span class="o">=</span> <span class="n">bar_width</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">xdata</span><span class="p">[</span><span class="n">ndata</span><span class="p">]</span>
            <span class="n">boffset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">xret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="o">+</span><span class="n">boffset</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bar</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">bar_width</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">color</span><span class="p">,</span>
                   <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">pos</span><span class="o">+</span><span class="n">boffset</span> <span class="k">for</span> <span class="n">dat</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">],</span> 
                    <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="n">ms</span><span class="p">,</span> <span class="n">mew</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">mfc</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">paired</span><span class="p">:</span>
                <span class="n">xys</span><span class="o">.</span><span class="n">append</span><span class="p">([[</span><span class="n">pos</span><span class="o">+</span><span class="n">boffset</span><span class="p">,</span> <span class="n">dat</span><span class="p">]</span> <span class="k">for</span> <span class="n">dat</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ymax</span><span class="p">:</span>
                <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ymin</span><span class="p">:</span>
                <span class="n">ymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="o">+</span><span class="n">data</span><span class="o">.</span><span class="n">err</span> <span class="o">&gt;</span> <span class="n">ymax</span><span class="p">:</span>
            <span class="n">ymax</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="o">+</span><span class="n">data</span><span class="o">.</span><span class="n">err</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="o">-</span><span class="n">data</span><span class="o">.</span><span class="n">err</span> <span class="o">&lt;</span> <span class="n">ymin</span><span class="p">:</span>
            <span class="n">ymin</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="o">-</span><span class="n">data</span><span class="o">.</span><span class="n">err</span>

        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">yerr_offset</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">err</span><span class="o">/</span><span class="mf">2.0</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">bar</span><span class="p">:</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">ymarker</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="o">+</span><span class="n">sign</span><span class="o">*</span><span class="n">yerr_offset</span>
                <span class="n">yerr</span> <span class="o">=</span> <span class="n">sign</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">err</span><span class="o">/</span><span class="mf">2.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;-_&#39;</span>
                <span class="n">ymarker</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span>
                <span class="n">yerr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">err</span>

            <span class="n">erb</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">pos</span><span class="o">+</span><span class="n">boffset</span><span class="p">,</span> <span class="n">ymarker</span><span class="p">,</span>
                              <span class="n">yerr</span><span class="o">=</span><span class="n">yerr</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">,</span> <span class="n">ecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                              <span class="n">ms</span><span class="o">=</span><span class="n">ms</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">erbs</span> <span class="ow">in</span> <span class="n">erb</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">erbs</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bar</span><span class="p">:</span>
                <span class="n">erb</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span> <span class="c1"># make lower error cap invisible</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">pos</span><span class="o">+</span><span class="n">boffset</span><span class="o">*</span><span class="mi">1</span><span class="p">,</span> <span class="n">labelpos</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
                <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">xdata</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">+=</span> <span class="n">bar_width</span><span class="o">+</span><span class="n">gap2</span>

    <span class="k">if</span> <span class="n">paired</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">nxy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xys</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">nxy</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">xys</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">nxy</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span>
                    <span class="p">[</span><span class="n">xys</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">nxy</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">xys</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">nxy</span><span class="p">][</span><span class="mi">1</span><span class="p">]],</span> <span class="s1">&#39;-k&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ymax</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ymin</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">ymax</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ymin</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">ylabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ylim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">xdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">paired</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">datasets</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;t-test, </span><span class="si">%s</span><span class="s2"> vs </span><span class="si">%s</span><span class="s2">, P=</span><span class="si">%.4f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">datasets</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">P</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">F</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">f_oneway</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">dataset</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">])</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ANOVA, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; vs </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dataset</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;, P=</span><span class="si">%.4f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">P</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">xret</span>


<div class="viewcode-block" id="get_rois_cnmf"><a class="viewcode-back" href="../usage/pipeline2p.html#pipeline2p.get_rois_cnmf">[docs]</a><span class="k">def</span> <span class="nf">get_rois_cnmf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">haussio_data</span><span class="p">,</span> <span class="n">vrdict</span><span class="p">,</span> <span class="n">speed_thr</span><span class="p">,</span> <span class="n">time_thr</span><span class="p">,</span> <span class="n">nrois_init</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identify ROIs, extract fluorescence and infer spikes using constrained</span>
<span class="sd">    non-negative matrix factorization (CNMF)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : ThorExperiment</span>
<span class="sd">        The ThorExperiment to be processed</span>
<span class="sd">    haussio_data : haussio.HaussIO</span>
<span class="sd">        haussio.HaussIO instance</span>
<span class="sd">    vrdict : dict</span>
<span class="sd">        Dictionary with processed VR data</span>
<span class="sd">    speed_thr : float</span>
<span class="sd">        Speed threshold</span>
<span class="sd">    time_thr : float</span>
<span class="sd">        Maximal resting duration</span>
<span class="sd">        If the resting period is shorter than time_thr, it will be counted as</span>
<span class="sd">        a non-stationary period</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rois : sima.ROI.ROIList</span>
<span class="sd">        sima ROIList to be plotted</span>
<span class="sd">    measured : numpy.ndarray</span>
<span class="sd">        Processed fluorescence data for each ROI</span>
<span class="sd">    zproj : numpy.ndarray</span>
<span class="sd">        z-projected fluorescence image</span>
<span class="sd">    spikes : numpy.ndarray</span>
<span class="sd">        Spike inference values</span>
<span class="sd">    vrdict : dict</span>
<span class="sd">        Dictionary with processed VR data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">vrdict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c1"># Remove data periods during which the animal is moving at less than</span>
        <span class="c1"># 1cm/s for more than 2s:</span>
        <span class="n">mask2p</span> <span class="o">=</span> <span class="n">contiguous_stationary</span><span class="p">(</span>
            <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;speed2p&quot;</span><span class="p">],</span> <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;framet2p&quot;</span><span class="p">],</span> <span class="n">speed_thr</span><span class="p">,</span> <span class="n">time_thr</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{0:.2f} </span><span class="si">%%</span><span class="s2"> stationary&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask2p</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">mask2p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mf">100.0</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{0} frames&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">mask2p</span><span class="p">))))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mask2p</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">rois</span><span class="p">,</span> <span class="n">measured</span><span class="p">,</span> <span class="n">zproj</span><span class="p">,</span> <span class="n">spikes</span><span class="p">,</span> <span class="n">movie</span><span class="p">,</span> <span class="n">noise</span> <span class="o">=</span> \
        <span class="n">cnmf</span><span class="o">.</span><span class="n">process_data_patches</span><span class="p">(</span>
            <span class="n">haussio_data</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask2p</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nrois_init</span><span class="o">=</span><span class="n">nrois_init</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vrdict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;evlist&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">time</span> <span class="o">&gt;</span> <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;frametvr&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-3</span><span class="p">:</span>
            <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;evlist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ev</span> <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;evlist&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">time</span> <span class="o">&lt;=</span> <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;frametvr&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-3</span><span class="p">]</span>

        <span class="n">maskvr</span> <span class="o">=</span> <span class="n">contiguous_stationary</span><span class="p">(</span>
            <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;speedvr&quot;</span><span class="p">],</span> <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;frametvr&quot;</span><span class="p">],</span> <span class="n">speed_thr</span><span class="p">,</span> <span class="n">time_thr</span><span class="p">)</span>

        <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;evlist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collapse_events</span><span class="p">(</span>
            <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;frametvr&quot;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">maskvr</span><span class="p">,</span> <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;evlist&quot;</span><span class="p">])</span>
        <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;vrtimes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collapse_time</span><span class="p">(</span><span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;vrtimes&quot;</span><span class="p">],</span> <span class="n">maskvr</span><span class="p">)</span>
        <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;frametvr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collapse_time</span><span class="p">(</span><span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;frametvr&quot;</span><span class="p">],</span> <span class="n">maskvr</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;posx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;posx&quot;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">maskvr</span><span class="p">)]</span>
        <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;posy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;posy&quot;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">maskvr</span><span class="p">)]</span>
        <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;speedvr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;speedvr&quot;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">maskvr</span><span class="p">)][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;framet2p&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collapse_time</span><span class="p">(</span><span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;framet2p&quot;</span><span class="p">],</span> <span class="n">mask2p</span><span class="p">)</span>
        <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;speed2p&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vrdict</span><span class="p">[</span><span class="s2">&quot;speed2p&quot;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">mask2p</span><span class="p">)]</span>

    <span class="n">measured</span> <span class="o">=</span> <span class="n">process_data</span><span class="p">(</span><span class="n">measured</span><span class="p">,</span> <span class="n">base_fraction</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">zscore</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rois</span><span class="p">,</span> <span class="n">measured</span><span class="p">,</span> <span class="n">zproj</span><span class="p">,</span> <span class="n">spikes</span><span class="p">,</span> <span class="n">vrdict</span></div>


<span class="k">def</span> <span class="nf">collapse_time</span><span class="p">(</span><span class="n">time_full</span><span class="p">,</span> <span class="n">maskvr</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_full</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">maskvr</span><span class="p">):</span>
        <span class="n">maskvr</span> <span class="o">=</span> <span class="n">maskvr</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time_full</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">maskvr</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time_full</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">maskvr</span><span class="p">))</span>
        <span class="k">raise</span> <span class="n">err</span>

    <span class="n">time_collapse</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">]</span>
    <span class="k">for</span> <span class="n">dtf</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">time_full</span><span class="p">),</span> <span class="n">maskvr</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mask</span><span class="p">:</span>
            <span class="n">time_collapse</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time_collapse</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dtf</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">time_collapse</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">collapse_events</span><span class="p">(</span><span class="n">time_full</span><span class="p">,</span> <span class="n">maskvr</span><span class="p">,</span> <span class="n">evlist</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">training</span>
    <span class="kn">import</span> <span class="nn">imp</span>
    <span class="n">imp</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">training</span><span class="p">)</span>

    <span class="n">evlist_copy</span> <span class="o">=</span> <span class="p">[</span><span class="n">ev</span> <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">evlist</span><span class="p">]</span>
    <span class="n">evlist_collapse</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">old_times</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">maskvr_start_rest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">maskvr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">maskvr_stop_rest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">maskvr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">start_rest</span> <span class="ow">in</span> <span class="n">maskvr_start_rest</span><span class="p">:</span>
        <span class="n">evlist_copy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">training</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="n">time_full</span><span class="p">[</span><span class="n">start_rest</span><span class="p">],</span> <span class="n">b</span><span class="s1">&#39;SR&#39;</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">stop_rest</span> <span class="ow">in</span> <span class="n">maskvr_stop_rest</span><span class="p">:</span>
        <span class="n">evlist_copy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">training</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="n">time_full</span><span class="p">[</span><span class="n">stop_rest</span><span class="p">],</span> <span class="n">b</span><span class="s1">&#39;SM&#39;</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">evlist_copy</span><span class="p">:</span>
        <span class="c1"># find closest time:</span>
        <span class="n">closest_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">time</span> <span class="o">&lt;=</span> <span class="n">time_full</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">maskvr</span><span class="p">[</span><span class="n">closest_time</span><span class="p">]:</span>
            <span class="n">old_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
            <span class="n">evlist_collapse</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">training</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">evcode</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">tf</span><span class="p">,</span> <span class="n">dtf</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">time_full</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">time_full</span><span class="p">),</span> <span class="n">maskvr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">nev</span><span class="p">,</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">evlist_collapse</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">old_times</span><span class="p">[</span><span class="n">nev</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">tf</span><span class="p">:</span>
                    <span class="n">evlist_collapse</span><span class="p">[</span><span class="n">nev</span><span class="p">]</span><span class="o">.</span><span class="n">time</span> <span class="o">-=</span> <span class="n">dtf</span>

    <span class="k">return</span> <span class="n">evlist_collapse</span>


<div class="viewcode-block" id="contiguous_stationary"><a class="viewcode-back" href="../usage/pipeline2p.html#pipeline2p.contiguous_stationary">[docs]</a><span class="k">def</span> <span class="nf">contiguous_stationary</span><span class="p">(</span><span class="n">speed</span><span class="p">,</span> <span class="n">speed_time</span><span class="p">,</span> <span class="n">speed_thr</span><span class="p">,</span> <span class="n">time_thr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find contiguous stationary periods</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    speed : numpy.ndarray</span>
<span class="sd">        Running speed</span>
<span class="sd">    speed_time : numpy.ndarray</span>
<span class="sd">        Time of running speed</span>
<span class="sd">    speed_thr : float</span>
<span class="sd">        Speed threshold</span>
<span class="sd">    time_thr : float</span>
<span class="sd">        Maximal resting duration</span>
<span class="sd">        If the resting period is shorter than time_thr, it will be counted as</span>
<span class="sd">        a non-stationary period</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    running_mask : numpy.ndarray</span>
<span class="sd">        Boolean mask denoting stationary periods</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Mask running periods (running: mask=True)</span>
    <span class="n">speed_masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">speed</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">speed</span> <span class="o">&gt;=</span> <span class="n">speed_thr</span><span class="p">)</span>

    <span class="c1"># Look for contiguous regions of unmasked (resting) values:</span>
    <span class="n">contiguous_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">notmasked_contiguous</span><span class="p">(</span><span class="n">speed_masked</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">nci</span><span class="p">,</span> <span class="n">ci</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contiguous_indices</span><span class="p">):</span>
        <span class="n">contiguous_duration</span> <span class="o">=</span> <span class="n">speed_time</span><span class="p">[</span><span class="n">ci</span><span class="o">.</span><span class="n">stop</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">speed_time</span><span class="p">[</span><span class="n">ci</span><span class="o">.</span><span class="n">start</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">contiguous_duration</span> <span class="o">&lt;</span> <span class="n">time_thr</span><span class="p">:</span>
            <span class="c1"># If this resting period is shorter than time_thr,</span>
            <span class="c1"># count it as a running period (mask=True)</span>
            <span class="n">speed_masked</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">ci</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c1"># return inverted mask (stationary: mask=True)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">speed_masked</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span></div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2016, Christoph Schmidt-Hieber.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.4.<br/>
    </p>
  </div>
</footer>
  </body>
</html>